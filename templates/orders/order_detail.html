{% extends "base.html" %}
{% load jalali_tags %}

{% block title %}{{ order.order_number }} | Ø¯ÛŒØ§Ú©Ùˆ MES{% endblock %}

{% block breadcrumb %}
<div class="row">
    <div class="col-12">
        <div class="page-header">
            <div class="page-header-title">
                <h4 class="mb-0">{{ order.order_number }}</h4>
            </div>
            <div class="page-header-breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'orders:order_list' %}">Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                    <li class="breadcrumb-item active">{{ order.order_number }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row g-4">

    {# â”€â”€ Ø³ØªÙˆÙ† Ø§ØµÙ„ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <div class="col-lg-8">

        {# Ø®Ù„Ø§ØµÙ‡ Ø§ØµÙ„ÛŒ #}
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <h4 class="mb-0 f-w-700">{{ order.order_number }}</h4>
                            {# Ø¨Ø¬ ÙˆØ¶Ø¹ÛŒØª #}
                            <span id="statusBadge" class="badge fs-6
                                {% if order.status == 'in_production' %}bg-primary
                                {% elif order.status == 'delivered' %}bg-success
                                {% elif order.status == 'cancelled' %}bg-danger
                                {% elif order.status == 'quality_check' %}bg-warning text-dark
                                {% elif order.status == 'ready' %}bg-info
                                {% elif order.status == 'sample_sent' %}bg-purple
                                {% elif order.status == 'customer_approved' %}bg-teal
                                {% else %}bg-secondary
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                            {# Ø§ÙˆÙ„ÙˆÛŒØª #}
                            {% if order.priority == 'urgent' %}
                            <span class="badge bg-danger">ğŸ”´ ÙÙˆØ±ÛŒ</span>
                            {% elif order.priority == 'high' %}
                            <span class="badge bg-warning text-dark">ğŸŸ  Ø¨Ø§Ù„Ø§</span>
                            {% endif %}
                        </div>
                        <div class="text-muted f-s-14">
                            Ø«Ø¨Øª: {{ order.created_at|to_jalali }} | ØªÙˆØ³Ø· {{ order.created_by.get_full_name }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <a href="{% url 'orders:order_edit' order.pk %}" class="btn btn-outline-primary">
                            <i class="ti ti-edit me-1"></i> ÙˆÛŒØ±Ø§ÛŒØ´
                        </a>
                    </div>
                </div>

                {# Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª #}
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="f-s-13 fw-semibold">Ù¾ÛŒØ´Ø±ÙØª ØªÙˆÙ„ÛŒØ¯</span>
                        <span class="f-s-13 fw-semibold" id="progressText">{{ order.progress_pct }}%</span>
                    </div>
                    <div class="progress" style="height:12px; border-radius:6px;">
                        <div id="progressBar"
                             class="progress-bar {% if order.progress_pct < 30 %}bg-danger{% elif order.progress_pct < 70 %}bg-warning{% else %}bg-success{% endif %}"
                             style="width:{{ order.progress_pct }}%; transition:width .5s;"></div>
                    </div>
                </div>

                {# Ù†ÙˆØ§Ø± Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± #}
                <div class="mt-4">
                    <div class="d-flex align-items-center gap-0 workflow-bar">
                        {% with steps="draft,sample_sent,customer_approved,confirmed,in_production,quality_check,ready,delivered" %}
                        {% for step in steps.split %}
                        {# Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± JS Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ #}
                        {% endfor %}
                        {% endwith %}
                    </div>
                    {# Ù†ÙˆØ§Ø± Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± â€” Ø³Ø§Ø¯Ù‡ Ø¨Ø§ CSS #}
                    <div class="workflow-steps mt-2">
                        <div class="d-flex justify-content-between f-s-11 text-muted">
                            <span class="{% if order.status == 'draft' %}fw-bold text-secondary{% elif order.status in 'sample_sent,customer_approved,confirmed,in_production,quality_check,ready,delivered' %}text-success{% endif %}">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</span>
                            <span class="{% if order.status == 'sample_sent' %}fw-bold text-primary{% elif order.status in 'customer_approved,confirmed,in_production,quality_check,ready,delivered' %}text-success{% endif %}">Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</span>
                            <span class="{% if order.status == 'customer_approved' %}fw-bold text-primary{% elif order.status in 'confirmed,in_production,quality_check,ready,delivered' %}text-success{% endif %}">ØªØ£ÛŒÛŒØ¯ Ù…Ø´ØªØ±ÛŒ</span>
                            <span class="{% if order.status == 'confirmed' %}fw-bold text-primary{% elif order.status in 'in_production,quality_check,ready,delivered' %}text-success{% endif %}">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
                            <span class="{% if order.status == 'in_production' %}fw-bold text-primary{% elif order.status in 'quality_check,ready,delivered' %}text-success{% endif %}">ØªÙˆÙ„ÛŒØ¯</span>
                            <span class="{% if order.status == 'quality_check' %}fw-bold text-warning{% elif order.status in 'ready,delivered' %}text-success{% endif %}">Ú©Ù†ØªØ±Ù„</span>
                            <span class="{% if order.status == 'ready' %}fw-bold text-info{% elif order.status == 'delivered' %}text-success{% endif %}">Ø¢Ù…Ø§Ø¯Ù‡</span>
                            <span class="{% if order.status == 'delivered' %}fw-bold text-success{% endif %}">ØªØ­ÙˆÛŒÙ„</span>
                        </div>
                        <div class="progress mt-1" style="height:4px;">
                            <div class="progress-bar bg-success" style="width:
                                {% if order.status == 'draft' %}0%
                                {% elif order.status == 'sample_sent' %}14%
                                {% elif order.status == 'customer_approved' %}28%
                                {% elif order.status == 'confirmed' %}42%
                                {% elif order.status == 'in_production' %}57%
                                {% elif order.status == 'quality_check' %}71%
                                {% elif order.status == 'ready' %}85%
                                {% elif order.status == 'delivered' %}100%
                                {% else %}0%{% endif %}
                            ;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ #}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-info-circle me-2"></i>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <span class="text-muted f-s-12 d-block">Ù…Ø´ØªØ±ÛŒ</span>
                        <a href="{% url 'orders:customer_detail' order.customer.pk %}" class="f-w-600 text-decoration-none">
                            {{ order.customer.name }}
                            {% if order.customer.company %}
                            <span class="text-muted f-w-400">({{ order.customer.company }})</span>
                            {% endif %}
                        </a>
                    </div>
                    <div class="col-md-6">
                        <span class="text-muted f-s-12 d-block">Ù†ÙˆØ¹ Ù†Ø®</span>
                        <span class="f-w-600">
                            {{ order.yarn_type|default:"â€”" }}
                            {% if order.yarn_count %} Ne {{ order.yarn_count }}{% endif %}
                        </span>
                    </div>
                    <div class="col-md-4">
                        <span class="text-muted f-s-12 d-block">Ù…Ù‚Ø¯Ø§Ø± Ø³ÙØ§Ø±Ø´</span>
                        <span class="f-w-700 f-s-18">{{ order.quantity_kg|floatformat:0 }}</span>
                        <span class="text-muted f-s-12"> kg</span>
                    </div>
                    <div class="col-md-4">
                        <span class="text-muted f-s-12 d-block">ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</span>
                        <span class="f-w-600">{{ order.delivery_date|to_jalali|default:"ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡" }}</span>
                    </div>
                    <div class="col-md-4">
                        <span class="text-muted f-s-12 d-block">Ø®Ø· ØªÙˆÙ„ÛŒØ¯</span>
                        <span class="f-w-600">{{ order.production_line.name|default:"Ø§Ø®ØªØµØ§Øµ Ù†Ø´Ø¯Ù‡" }}</span>
                    </div>
                    {% if order.unit_price %}
                    <div class="col-md-6">
                        <span class="text-muted f-s-12 d-block">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</span>
                        <span class="f-w-600">{{ order.unit_price|floatformat:0 }} Ø±ÛŒØ§Ù„/kg</span>
                    </div>
                    <div class="col-md-6">
                        <span class="text-muted f-s-12 d-block">Ù…Ø¨Ù„Øº Ú©Ù„</span>
                        <span class="f-w-700 text-success f-s-16">{{ order.total_price|floatformat:0|default:"â€”" }} Ø±ÛŒØ§Ù„</span>
                    </div>
                    {% endif %}
                    {% if order.color_shade %}
                    <div class="col-md-6">
                        <span class="text-muted f-s-12 d-block">Ø´ÛŒØ¯ Ø±Ù†Ú¯ÛŒ</span>
                        <span class="f-w-600">
                            {% if order.color_shade.color_hex %}
                            <span style="display:inline-block;width:14px;height:14px;border-radius:50%;
                                background:{{ order.color_shade.color_hex }};border:1px solid #ccc;
                                vertical-align:middle;margin-left:5px;"></span>
                            {% endif %}
                            {{ order.color_shade.code }} â€” {{ order.color_shade.name }}
                        </span>
                    </div>
                    {% endif %}
                    {% if order.notes %}
                    <div class="col-12">
                        <span class="text-muted f-s-12 d-block">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</span>
                        <span>{{ order.notes }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

    {# â”€â”€ Ø³ØªÙˆÙ† Ú©Ù†Ø§Ø±ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <div class="col-lg-4">

        {# ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª â€” Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±ÛŒ #}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-replace me-2"></i>ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</h5>
            </div>
            <div class="card-body d-grid gap-2" id="statusButtons">

                {% if order.status == 'draft' %}
                <div class="alert alert-light border f-s-13 py-2">
                    <i class="ti ti-info-circle me-1"></i>
                    Ø§Ø¨ØªØ¯Ø§ Ù†Ù…ÙˆÙ†Ù‡ Ø´ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
                </div>
                <button class="btn btn-outline-primary text-start"
                        onclick="doChangeStatus('sample_sent', 'Ù†Ù…ÙˆÙ†Ù‡ Ø´ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯')">
                    <i class="ti ti-send me-2"></i>Ø§Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ
                </button>
                <button class="btn btn-outline-secondary text-start"
                        onclick="doChangeStatus('confirmed', 'ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡')">
                    <i class="ti ti-check me-2"></i>ØªØ£ÛŒÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ù†Ù…ÙˆÙ†Ù‡)
                </button>

                {% elif order.status == 'sample_sent' %}
                <div class="alert alert-info border f-s-13 py-2">
                    <i class="ti ti-clock me-1"></i>
                    Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø´ØªØ±ÛŒ...
                </div>
                <button class="btn btn-outline-success text-start"
                        onclick="doChangeStatus('customer_approved', 'Ù…Ø´ØªØ±ÛŒ ØªØ£ÛŒÛŒØ¯ Ú©Ø±Ø¯')">
                    <i class="ti ti-thumb-up me-2"></i>Ù…Ø´ØªØ±ÛŒ ØªØ£ÛŒÛŒØ¯ Ú©Ø±Ø¯ âœ“
                </button>
                <button class="btn btn-outline-warning text-start"
                        onclick="doChangeStatus('draft', 'Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³')">
                    <i class="ti ti-refresh me-2"></i>Ù…Ø´ØªØ±ÛŒ ØªØºÛŒÛŒØ± Ø®ÙˆØ§Ø³Øª (Ø¨Ø±Ú¯Ø´Øª)
                </button>

                {% elif order.status == 'customer_approved' %}
                <div class="alert alert-success border f-s-13 py-2">
                    <i class="ti ti-circle-check me-1"></i>
                    Ù…Ø´ØªØ±ÛŒ ØªØ£ÛŒÛŒØ¯ Ú©Ø±Ø¯Ù‡ â€” Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ ØªÙˆÙ„ÛŒØ¯
                </div>
                <button class="btn btn-outline-primary text-start"
                        onclick="doChangeStatus('confirmed', 'ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯')">
                    <i class="ti ti-arrow-left me-2"></i>ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯
                </button>

                {% elif order.status == 'confirmed' %}
                <div class="alert alert-light border f-s-13 py-2">
                    <i class="ti ti-checks me-1"></i>
                    Ø³ÙØ§Ø±Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ â€” Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯
                </div>
                <button class="btn btn-primary text-start"
                        onclick="doChangeStatus('in_production', 'Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯')">
                    <i class="ti ti-player-play me-2"></i>Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯
                </button>

                {% elif order.status == 'in_production' %}
                <div class="alert alert-primary border f-s-13 py-2">
                    <i class="ti ti-settings me-1"></i>
                    Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯...
                </div>
                <button class="btn btn-outline-warning text-start"
                        onclick="doChangeStatus('quality_check', 'Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª')">
                    <i class="ti ti-microscope me-2"></i>Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª
                </button>

                {% elif order.status == 'quality_check' %}
                <div class="alert alert-warning border f-s-13 py-2">
                    <i class="ti ti-microscope me-1"></i>
                    Ø¯Ø± Ø­Ø§Ù„ Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª...
                </div>
                <button class="btn btn-outline-info text-start"
                        onclick="doChangeStatus('ready', 'ØªØ£ÛŒÛŒØ¯ Ú©ÛŒÙÛŒØª â€” Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„')">
                    <i class="ti ti-package me-2"></i>ØªØ£ÛŒÛŒØ¯ Ú©ÛŒÙÛŒØª â€” Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„
                </button>
                <button class="btn btn-outline-danger text-start"
                        onclick="doChangeStatus('in_production', 'Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯ (Ø±Ø¯ Ú©ÛŒÙÛŒØª)')">
                    <i class="ti ti-refresh me-2"></i>Ø±Ø¯ Ú©ÛŒÙÛŒØª â€” Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯
                </button>

                {% elif order.status == 'ready' %}
                <div class="alert alert-info border f-s-13 py-2">
                    <i class="ti ti-package me-1"></i>
                    Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ
                </div>
                <button class="btn btn-success text-start"
                        onclick="doChangeStatus('delivered', 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯')">
                    <i class="ti ti-truck me-2"></i>ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ âœ“
                </button>

                {% elif order.status == 'delivered' %}
                <div class="alert alert-success border f-s-13 py-2 mb-0">
                    <i class="ti ti-circle-check me-1"></i>
                    Ø³ÙØ§Ø±Ø´ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ âœ“
                </div>

                {% elif order.status == 'cancelled' %}
                <div class="alert alert-danger border f-s-13 py-2 mb-0">
                    <i class="ti ti-ban me-1"></i>
                    Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯Ù‡
                </div>
                {% endif %}

                {# Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ (Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ â€” Ø¬Ø² ØªØ­ÙˆÛŒÙ„ Ùˆ Ù„ØºÙˆØ´Ø¯Ù‡) #}
                {% if order.status not in 'delivered,cancelled' %}
                <hr class="my-1">
                <button class="btn btn-outline-danger btn-sm text-start"
                        onclick="doCancelOrder()">
                    <i class="ti ti-x me-2"></i>Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´
                </button>
                {% endif %}

            </div>
        </div>

        {# Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ #}
        <div class="card">
            <div class="card-body d-grid gap-2">
                <a href="{% url 'orders:order_edit' order.pk %}" class="btn btn-primary">
                    <i class="ti ti-edit me-1"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´
                </a>
                <a href="{% url 'orders:order_create' %}?customer={{ order.customer.pk }}"
                   class="btn btn-outline-success">
                    <i class="ti ti-plus me-1"></i> Ø³ÙØ§Ø±Ø´ Ù…Ø´Ø§Ø¨Ù‡
                </a>
                <a href="{% url 'orders:customer_detail' order.customer.pk %}"
                   class="btn btn-outline-secondary">
                    <i class="ti ti-user me-1"></i> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ
                </a>
                <a href="{% url 'orders:order_list' %}" class="btn btn-outline-secondary">
                    <i class="ti ti-arrow-right me-1"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
                </a>
            </div>
        </div>

    </div>
</div>

<style>
.workflow-steps span { font-size: 11px; }
</style>
{% endblock %}

{% block extra_js %}
{# ÙØ±Ù… Ù…Ø®ÙÛŒ â€” submit Ø³Ø§Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† AJAX #}
<form id="statusForm" method="post" action="{% url 'orders:order_status' order.pk %}" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="status" id="statusInput">
</form>
<form id="cancelForm" method="post" action="{% url 'orders:order_cancel' order.pk %}" style="display:none;">
    {% csrf_token %}
</form>

<script>
function doChangeStatus(newStatus, label) {
    if (confirm('ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ Â«' + label + 'Â» ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŸ')) {
        document.getElementById('statusInput').value = newStatus;
        document.getElementById('statusForm').submit();
    }
}

function doCancelOrder() {
    if (confirm('Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´ÙˆØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) {
        document.getElementById('cancelForm').submit();
    }
}
</script>
{% endblock %}
