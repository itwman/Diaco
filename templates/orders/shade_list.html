{% extends "includes/list_base.html" %}

{% block header_actions %}
<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#shadeModal">
    <i class="ti ti-plus me-1"></i> شید جدید
</button>
{% endblock %}

{% block table_headers %}
<th>#</th>
<th>رنگ</th>
<th>کد</th>
<th>نام</th>
<th>تأیید</th>
<th>یادداشت</th>
<th></th>
{% endblock %}

{% block table_body %}
{% for shade in object_list %}
<tr>
    <td>{{ forloop.counter }}</td>
    <td>
        <span class="d-inline-block rounded" style="width:28px;height:28px;background:{{ shade.color_hex|default:'#ccc' }};vertical-align:middle;border:1px solid #ddd;"></span>
    </td>
    <td class="f-w-600">{{ shade.code }}</td>
    <td>{{ shade.name }}</td>
    <td>
        {% if shade.is_approved %}
        <span class="badge bg-light-success text-success">تأیید شده</span>
        {% else %}
        <span class="badge bg-light-warning text-warning">در انتظار</span>
        {% endif %}
    </td>
    <td><small class="text-muted">{{ shade.notes|truncatechars:30 }}</small></td>
    <td class="text-end">
        <button class="btn btn-sm btn-outline-secondary py-0 px-2"
                onclick="editShade({{ shade.id }}, '{{ shade.code }}', '{{ shade.name }}', '{{ shade.color_hex }}', {{ shade.is_approved|yesno:'true,false' }}, '{{ shade.notes|escapejs }}')">
            <i class="ti ti-edit f-s-14"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger py-0 px-2"
                onclick="deleteShade({{ shade.id }}, '{{ shade.code }} - {{ shade.name }}')">
            <i class="ti ti-trash f-s-14"></i>
        </button>
    </td>
</tr>
{% endfor %}
{% endblock %}

{% block extra_content %}
<!-- Modal افزودن/ویرایش شید -->
<div class="modal fade" id="shadeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shadeModalTitle">شید رنگی جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="shadeForm">
                {% csrf_token %}
                <input type="hidden" id="shadeId" value="">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">کد شید <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="shadeCode" placeholder="SH-1001" required maxlength="50">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-semibold">نام رنگ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="shadeName" placeholder="مثال: قرمز آتشی" required maxlength="200">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">کد رنگ HEX</label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color p-1" id="shadeHexPicker" value="#3498db" style="width:50px;min-width:50px">
                                <input type="text" class="form-control" id="shadeHex" placeholder="#3498db" maxlength="7" dir="ltr">
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div id="colorPreview" class="rounded" style="width:100%;height:38px;border:1px solid #ccc;background:#3498db;"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">وضعیت تأیید</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="shadeApproved">
                                <label class="form-check-label" for="shadeApproved">تأیید شده</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">یادداشت</label>
                            <textarea class="form-control" id="shadeNotes" rows="2" placeholder="توضیحات اضافی..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary" id="shadeSubmitBtn">
                        <i class="ti ti-check me-1"></i> ذخیره
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal تأیید حذف -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title">تأیید حذف</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="ti ti-alert-triangle text-danger f-s-36 d-block mb-2"></i>
                <p>آیا از حذف <strong id="deleteItemName"></strong> اطمینان دارید؟</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">خیر</button>
                <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteBtn">بله، حذف شود</button>
            </div>
        </div>
    </div>
</div>

<script>
// ── picker رنگ sync ──────────────────────────────────────────
document.getElementById('shadeHexPicker').addEventListener('input', function() {
    document.getElementById('shadeHex').value = this.value;
    document.getElementById('colorPreview').style.background = this.value;
});
document.getElementById('shadeHex').addEventListener('input', function() {
    if (/^#[0-9a-fA-F]{6}$/.test(this.value)) {
        document.getElementById('shadeHexPicker').value = this.value;
        document.getElementById('colorPreview').style.background = this.value;
    }
});

// ── reset modal ─────────────────────────────────────────────
document.getElementById('shadeModal').addEventListener('show.bs.modal', function() {
    if (!document.getElementById('shadeId').value) {
        document.getElementById('shadeModalTitle').textContent = 'شید رنگی جدید';
        document.getElementById('shadeForm').reset();
        document.getElementById('shadeHexPicker').value = '#3498db';
        document.getElementById('colorPreview').style.background = '#3498db';
    }
});
document.getElementById('shadeModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('shadeId').value = '';
    document.getElementById('shadeModalTitle').textContent = 'شید رنگی جدید';
    document.getElementById('shadeForm').reset();
    document.getElementById('colorPreview').style.background = '#3498db';
});

// ── ویرایش ─────────────────────────────────────────────────
function editShade(id, code, name, hex, approved, notes) {
    document.getElementById('shadeId').value = id;
    document.getElementById('shadeModalTitle').textContent = 'ویرایش شید ' + code;
    document.getElementById('shadeCode').value = code;
    document.getElementById('shadeName').value = name;
    document.getElementById('shadeHex').value = hex || '';
    document.getElementById('shadeHexPicker').value = hex || '#cccccc';
    document.getElementById('colorPreview').style.background = hex || '#cccccc';
    document.getElementById('shadeApproved').checked = approved;
    document.getElementById('shadeNotes').value = notes || '';
    new bootstrap.Modal(document.getElementById('shadeModal')).show();
}

// ── ذخیره (افزودن/ویرایش) ──────────────────────────────────
document.getElementById('shadeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('shadeId').value;
    const url = id ? `/orders/shades/${id}/edit/` : `/orders/shades/create/`;
    const data = new FormData();
    data.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    data.append('code', document.getElementById('shadeCode').value.trim().toUpperCase());
    data.append('name', document.getElementById('shadeName').value.trim());
    data.append('color_hex', document.getElementById('shadeHex').value.trim());
    data.append('is_approved', document.getElementById('shadeApproved').checked ? 'on' : '');
    data.append('notes', document.getElementById('shadeNotes').value.trim());

    const btn = document.getElementById('shadeSubmitBtn');
    btn.disabled = true;
    fetch(url, {method: 'POST', body: data})
        .then(r => r.json())
        .then(res => {
            if (res.ok) { location.reload(); }
            else { alert('خطا: ' + res.error); btn.disabled = false; }
        })
        .catch(() => { btn.disabled = false; });
});

// ── حذف ────────────────────────────────────────────────────
let deleteId = null;
function deleteShade(id, name) {
    deleteId = id;
    document.getElementById('deleteItemName').textContent = name;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (!deleteId) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const data = new FormData(); data.append('csrfmiddlewaretoken', csrf);
    fetch(`/orders/shades/${deleteId}/delete/`, {method: 'POST', body: data})
        .then(r => r.json())
        .then(res => { if (res.ok) location.reload(); else alert(res.error); });
});
</script>
{% endblock %}
