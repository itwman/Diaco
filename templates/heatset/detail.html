{% extends "base.html" %}
{% load static %}
{% load jalali_tags %}

{% block title %}{{ page_title }} | Ø¯ÛŒØ§Ú©Ùˆ MES{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/apexcharts/apexcharts.css' %}" rel="stylesheet">
{% endblock %}

{% block breadcrumb %}
<div class="row">
    <div class="col-12">
        <div class="page-header">
            <div class="page-header-title"><h4 class="mb-0">{{ page_title }}</h4></div>
            <div class="page-header-breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                    <li class="breadcrumb-item">{{ breadcrumb_parent }}</li>
                    <li class="breadcrumb-item"><a href="{% url 'heatset:list' %}">Ù„ÛŒØ³Øª</a></li>
                    <li class="breadcrumb-item active">{{ batch.batch_number }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">

    {# â”€â”€ Ø³ØªÙˆÙ† Ú†Ù¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <div class="col-xl-8">

        {# Ù‡Ø¯Ø± Ø¨Ú† #}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <h4 class="mb-1 font-monospace text-danger">{{ batch.batch_number }}</h4>
                        <div class="text-muted f-s-13">
                            <i class="ti ti-calendar me-1"></i>{{ batch.production_date|to_jalali }}
                            &nbsp;|&nbsp;<i class="ti ti-device-desktop me-1"></i>{{ batch.machine.code }}
                            &nbsp;|&nbsp;<span class="text-danger f-w-600">{{ batch.temperature_c }}Â°C</span>
                            &nbsp;|&nbsp;<i class="ti ti-user me-1"></i>{{ batch.operator.get_full_name }}
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        {% if batch.status == 'loading' %}
                        <span class="badge bg-secondary f-s-13 px-3 py-2">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</span>
                        {% elif batch.status == 'processing' %}
                        <span class="badge bg-danger f-s-13 px-3 py-2">Ø¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ ğŸ”¥</span>
                        {% elif batch.status == 'cooling' %}
                        <span class="badge bg-info f-s-13 px-3 py-2">Ø³Ø±Ø¯Ø´Ø¯Ù† â„ï¸</span>
                        {% elif batch.status == 'completed' %}
                        <span class="badge bg-success f-s-13 px-3 py-2">ØªÚ©Ù…ÛŒÙ„ âœ“</span>
                        {% elif batch.status == 'failed' %}
                        <span class="badge bg-danger f-s-13 px-3 py-2">Ù†Ø§Ù…ÙˆÙÙ‚ âœ—</span>
                        {% endif %}
                        <a href="{% url 'heatset:edit' batch.pk %}" class="btn btn-outline-secondary btn-sm">
                            <i class="ti ti-pencil me-1"></i>ÙˆÛŒØ±Ø§ÛŒØ´
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# Ø¬Ø¯ÙˆÙ„ Ø¬Ø²Ø¦ÛŒØ§Øª #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0">Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯</h6></div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <tbody>
                        <tr>
                            <th class="bg-light" style="width:35%">Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
                            <td>{{ batch.get_machine_type_hs_display }}</td>
                            <th class="bg-light">Ù†ÙˆØ¹ Ø§Ù„ÛŒØ§Ù</th>
                            <td>{{ batch.get_fiber_type_display }}</td>
                        </tr>
                        <tr>
                            <th class="bg-light">Ù†ÙˆØ¹ Ú†Ø±Ø®Ù‡</th>
                            <td>{{ batch.get_cycle_type_display }}</td>
                            <th class="bg-light">Ø¯Ù…Ø§ÛŒ ØªØ«Ø¨ÛŒØª</th>
                            <td class="f-w-700 text-danger f-s-16">{{ batch.temperature_c }}Â°C</td>
                        </tr>
                        <tr>
                            <th class="bg-light">ÙØ´Ø§Ø± Ø¨Ø®Ø§Ø±</th>
                            <td>{% if batch.steam_pressure_bar %}{{ batch.steam_pressure_bar }} bar{% else %}â€”{% endif %}</td>
                            <th class="bg-light">Ø³Ø·Ø­ Ø®Ù„Ø£</th>
                            <td>{% if batch.vacuum_level_mbar %}{{ batch.vacuum_level_mbar }} mbar{% else %}â€”{% endif %}</td>
                        </tr>
                        <tr>
                            <th class="bg-light">Ø¨Ú† TFO ÙˆØ±ÙˆØ¯ÛŒ</th>
                            <td colspan="3">
                                {% if batch.tfo_production %}
                                <a href="{% url 'tfo:detail' batch.tfo_production.pk %}" class="font-monospace text-decoration-none">
                                    {{ batch.tfo_production.batch_number }}
                                </a>
                                {% else %}<span class="text-muted">â€”</span>{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th class="bg-light">ÙˆØ²Ù† Ø¨Ú†</th>
                            <td class="f-w-700 text-success">{{ batch.batch_weight_kg }} kg</td>
                            <th class="bg-light">ØªØ¹Ø¯Ø§Ø¯ Ø¨ÙˆØ¨ÛŒÙ†</th>
                            <td>{{ batch.packages_count|default:"â€”" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú†Ø±Ø®Ù‡ #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="ti ti-clock me-2"></i>Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú†Ø±Ø®Ù‡</h6></div>
            <div class="card-body">
                <div class="row g-2 text-center">
                    {% with steps="Ù¾ÛŒØ´â€ŒÚ¯Ø±Ù…|pre_heat_min,Ø®Ù„Ø£|vacuum_time_min,Ø¨Ø®Ø§Ø±|steam_time_min,Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ|dwell_time_min,Ø³Ø±Ø¯Ø´Ø¯Ù†|cooldown_min" %}
                    {% for step in steps|split:"," %}{% endfor %}
                    {% endwith %}
                    <div class="col">
                        <div class="border rounded p-2">
                            <div class="f-s-11 text-muted">Ù¾ÛŒØ´â€ŒÚ¯Ø±Ù…</div>
                            <div class="f-w-700">{% if batch.pre_heat_min %}{{ batch.pre_heat_min }} Ø¯Ù‚{% else %}â€”{% endif %}</div>
                        </div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center text-muted">â†’</div>
                    <div class="col">
                        <div class="border rounded p-2">
                            <div class="f-s-11 text-muted">Ø®Ù„Ø£</div>
                            <div class="f-w-700">{% if batch.vacuum_time_min %}{{ batch.vacuum_time_min }} Ø¯Ù‚{% else %}â€”{% endif %}</div>
                        </div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center text-muted">â†’</div>
                    <div class="col">
                        <div class="border rounded p-2 bg-light-danger">
                            <div class="f-s-11 text-danger">Ø¨Ø®Ø§Ø±</div>
                            <div class="f-w-700 text-danger">{% if batch.steam_time_min %}{{ batch.steam_time_min }} Ø¯Ù‚{% else %}â€”{% endif %}</div>
                        </div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center text-muted">â†’</div>
                    <div class="col">
                        <div class="border rounded p-2 bg-light-warning">
                            <div class="f-s-11 text-warning">Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ</div>
                            <div class="f-w-700 text-warning">{% if batch.dwell_time_min %}{{ batch.dwell_time_min }} Ø¯Ù‚{% else %}â€”{% endif %}</div>
                        </div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center text-muted">â†’</div>
                    <div class="col">
                        <div class="border rounded p-2 bg-light-info">
                            <div class="f-s-11 text-info">Ø³Ø±Ø¯Ø´Ø¯Ù†</div>
                            <div class="f-w-700 text-info">{% if batch.cooldown_min %}{{ batch.cooldown_min }} Ø¯Ù‚{% else %}â€”{% endif %}</div>
                        </div>
                    </div>
                </div>
                {% if batch.duration_min %}
                <div class="text-center mt-2 text-muted f-s-13">Ù…Ø¬Ù…ÙˆØ¹: <span class="f-w-700">{{ batch.duration_min }} Ø¯Ù‚ÛŒÙ‚Ù‡</span></div>
                {% endif %}
            </div>
        </div>

        {# Ù†Ù…ÙˆØ¯Ø§Ø± Ú†Ø±Ø®Ù‡ Ø¯Ù…Ø§/ÙØ´Ø§Ø± #}
        {% if log_count > 0 %}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h6 class="mb-0"><i class="ti ti-chart-line me-2 text-danger"></i>Ù†Ù…ÙˆØ¯Ø§Ø± Ú†Ø±Ø®Ù‡ Ø¯Ù…Ø§ / ÙØ´Ø§Ø± (AI-Ready)</h6>
                <span class="badge bg-light-secondary text-secondary">{{ log_count }} Ù†Ù‚Ø·Ù‡ Ù„Ø§Ú¯</span>
            </div>
            <div class="card-body">
                <div id="cycleChart"></div>
            </div>
        </div>
        {% endif %}

        {# Ø¬Ø¯ÙˆÙ„ Ù„Ø§Ú¯â€ŒÙ‡Ø§ #}
        {% if cycle_logs %}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h6 class="mb-0">Ù„Ø§Ú¯ Ú†Ø±Ø®Ù‡</h6>
                {% if batch.status in 'loading,processing,cooling' %}
                <button class="btn btn-danger btn-sm" onclick="document.getElementById('logForm').classList.toggle('d-none')">
                    <i class="ti ti-plus me-1"></i>Ø«Ø¨Øª Ù„Ø§Ú¯
                </button>
                {% endif %}
            </div>

            {# ÙØ±Ù… Ø«Ø¨Øª Ù„Ø§Ú¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ #}
            <div id="logForm" class="d-none card-body border-bottom bg-light-danger">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label f-s-12">Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø´Ø±ÙˆØ¹</label>
                        <input type="number" id="logElapsed" class="form-control form-control-sm" step="0.5" min="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label f-s-12">Ø¯Ù…Ø§ (Â°C)</label>
                        <input type="number" id="logTemp" class="form-control form-control-sm" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label f-s-12">ÙØ´Ø§Ø± (bar)</label>
                        <input type="number" id="logPressure" class="form-control form-control-sm" step="0.001">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label f-s-12">Ø±Ø·ÙˆØ¨Øª (%)</label>
                        <input type="number" id="logHumidity" class="form-control form-control-sm" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label f-s-12">Ù…Ø±Ø­Ù„Ù‡</label>
                        <select id="logPhase" class="form-select form-select-sm">
                            {% for val, label in phase_choices %}
                            <option value="{{ val }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger btn-sm w-100" onclick="submitLog()">Ø«Ø¨Øª</button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:250px;overflow-y:auto;">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr><th>Ø¯Ù‚ÛŒÙ‚Ù‡</th><th>Ø¯Ù…Ø§ (Â°C)</th><th>ÙØ´Ø§Ø± (bar)</th><th>Ø±Ø·ÙˆØ¨Øª (%)</th><th>Ù…Ø±Ø­Ù„Ù‡</th></tr>
                        </thead>
                        <tbody>
                            {% for log in cycle_logs %}
                            <tr>
                                <td>{{ log.elapsed_min|default:"â€”" }}</td>
                                <td class="{% if log.temperature_c %}text-danger f-w-600{% endif %}">{{ log.temperature_c|default:"â€”" }}</td>
                                <td>{{ log.pressure_bar|default:"â€”" }}</td>
                                <td>{{ log.humidity_pct|default:"â€”" }}</td>
                                <td><span class="badge bg-light-secondary text-secondary f-s-11">{{ log.get_phase_display }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        {# Ù†Ø´Ø§Ù† Ø«Ø¨Øª Ø§ÙˆÙ„ÛŒÙ† Ù„Ø§Ú¯ #}
        {% if batch.status in 'loading,processing,cooling' %}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h6 class="mb-0">Ù„Ø§Ú¯ Ú†Ø±Ø®Ù‡ Ø¯Ù…Ø§/ÙØ´Ø§Ø±</h6>
                <button class="btn btn-danger btn-sm" onclick="document.getElementById('logFormEmpty').classList.toggle('d-none')">
                    <i class="ti ti-plus me-1"></i>Ø«Ø¨Øª Ù„Ø§Ú¯
                </button>
            </div>
            <div id="logFormEmpty" class="d-none card-body border-bottom bg-light-danger">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2"><label class="form-label f-s-12">Ø¯Ù‚ÛŒÙ‚Ù‡</label><input type="number" id="logElapsed2" class="form-control form-control-sm" step="0.5" min="0"></div>
                    <div class="col-md-2"><label class="form-label f-s-12">Ø¯Ù…Ø§</label><input type="number" id="logTemp2" class="form-control form-control-sm" step="0.1"></div>
                    <div class="col-md-2"><label class="form-label f-s-12">ÙØ´Ø§Ø±</label><input type="number" id="logPressure2" class="form-control form-control-sm" step="0.001"></div>
                    <div class="col-md-2"><label class="form-label f-s-12">Ø±Ø·ÙˆØ¨Øª</label><input type="number" id="logHumidity2" class="form-control form-control-sm" step="0.1"></div>
                    <div class="col-md-2"><label class="form-label f-s-12">Ù…Ø±Ø­Ù„Ù‡</label>
                        <select id="logPhase2" class="form-select form-select-sm">
                            {% for val, label in phase_choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2"><button class="btn btn-danger btn-sm w-100" onclick="submitLog2()">Ø«Ø¨Øª</button></div>
                </div>
            </div>
            <div class="card-body text-center text-muted py-4">
                <i class="ti ti-chart-line-off f-s-30 d-block mb-2"></i>
                Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>

    {# â”€â”€ Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <div class="col-xl-4">

        {# Ù†ØªØ§ÛŒØ¬ Ú©ÛŒÙÛŒ #}
        <div class="card mb-3">
            <div class="card-header bg-light-success">
                <h6 class="mb-0 text-success"><i class="ti ti-star me-2"></i>Ù†ØªØ§ÛŒØ¬ Ú©ÛŒÙÛŒ</h6>
            </div>
            <div class="card-body text-center">
                {% if batch.quality_result %}
                <div class="mb-3">
                    {% if batch.quality_result == 'pass' %}
                    <div class="h-60 w-60 d-flex-center b-r-15 bg-success m-auto mb-2">
                        <i class="ti ti-check f-s-30 text-white"></i>
                    </div>
                    <div class="f-w-700 f-s-18 text-success">Ù‚Ø¨ÙˆÙ„ âœ“</div>
                    {% elif batch.quality_result == 'fail' %}
                    <div class="h-60 w-60 d-flex-center b-r-15 bg-danger m-auto mb-2">
                        <i class="ti ti-x f-s-30 text-white"></i>
                    </div>
                    <div class="f-w-700 f-s-18 text-danger">Ø±Ø¯ âœ—</div>
                    {% else %}
                    <div class="h-60 w-60 d-flex-center b-r-15 bg-warning m-auto mb-2">
                        <i class="ti ti-alert-triangle f-s-30 text-white"></i>
                    </div>
                    <div class="f-w-700 f-s-18 text-warning">Ù…Ø´Ø±ÙˆØ·</div>
                    {% endif %}
                </div>
                {% if batch.shrinkage_pct %}
                <div class="text-muted f-s-13">Ø¢Ù†Ú©Ø§Ú˜: <span class="f-w-600 text-dark">{{ batch.shrinkage_pct }}%</span></div>
                {% endif %}
                {% if batch.twist_stability %}
                <div class="text-muted f-s-13 mt-1">Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ ØªØ§Ø¨: <span class="f-w-600 text-dark">{{ batch.get_twist_stability_display }}</span></div>
                {% endif %}
                {% else %}
                <div class="text-muted py-2">
                    <i class="ti ti-clock f-s-24 d-block mb-1"></i>
                    Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ØªÛŒØ¬Ù‡
                </div>
                {% endif %}
            </div>
        </div>

        {# ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0">ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</h6></div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if batch.status == 'loading' %}
                    <button class="btn btn-danger" onclick="changeStatus('processing')">
                        <i class="ti ti-flame me-2"></i>Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯
                    </button>
                    {% elif batch.status == 'processing' %}
                    <button class="btn btn-info" onclick="changeStatus('cooling')">
                        <i class="ti ti-snowflake me-2"></i>Ø´Ø±ÙˆØ¹ Ø³Ø±Ø¯Ø´Ø¯Ù†
                    </button>
                    {% elif batch.status == 'cooling' %}
                    <div class="mb-2">
                        <select id="qualitySelect" class="form-select form-select-sm mb-2">
                            <option value="">Ù†ØªÛŒØ¬Ù‡ Ú©ÛŒÙÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>
                            {% for val, label in quality_choices %}
                            <option value="{{ val }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="changeStatusWithQuality('completed')">
                        <i class="ti ti-check me-2"></i>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
                    </button>
                    <button class="btn btn-outline-danger" onclick="changeStatusWithQuality('failed')">
                        <i class="ti ti-x me-2"></i>Ù†Ø§Ù…ÙˆÙÙ‚
                    </button>
                    {% elif batch.status in 'completed,failed' %}
                    <div class="alert alert-{% if batch.status == 'completed' %}success{% else %}danger{% endif %} py-2 mb-0 f-s-13">
                        <i class="ti ti-{% if batch.status == 'completed' %}check{% else %}x{% endif %}-circle me-2"></i>
                        {{ batch.get_status_display }}
                    </div>
                    {% endif %}
                </div>
                <div id="statusMsg" class="mt-2"></div>
            </div>
        </div>

        {% if batch.notes %}
        <div class="card">
            <div class="card-header"><h6 class="mb-0">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h6></div>
            <div class="card-body text-muted f-s-13">{{ batch.notes }}</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
<script>
const CSRF = '{{ csrf_token }}';
const BATCH_PK = {{ batch.pk }};

// â”€â”€ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function changeStatus(s, extra={}) {
    let body = `status=${s}`;
    for (const [k,v] of Object.entries(extra)) { if(v) body += `&${k}=${v}`; }
    const r = await fetch(`/heatset/${BATCH_PK}/status/`, {
        method:'POST', headers:{'X-CSRFToken':CSRF,'Content-Type':'application/x-www-form-urlencoded'}, body
    });
    const d = await r.json();
    if (d.ok) { setTimeout(()=>location.reload(), 700); }
    else { document.getElementById('statusMsg').innerHTML=`<div class="alert alert-danger py-1 f-s-12">${d.error}</div>`; }
}

function changeStatusWithQuality(s) {
    const q = document.getElementById('qualitySelect')?.value;
    changeStatus(s, {quality_result: q});
}

// â”€â”€ Ø«Ø¨Øª Ù„Ø§Ú¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitLog() {
    const body = new URLSearchParams({
        elapsed_min: document.getElementById('logElapsed').value,
        temperature_c: document.getElementById('logTemp').value,
        pressure_bar: document.getElementById('logPressure').value,
        humidity_pct: document.getElementById('logHumidity').value,
        phase: document.getElementById('logPhase').value,
    });
    const r = await fetch(`/heatset/${BATCH_PK}/log/add/`, {
        method:'POST', headers:{'X-CSRFToken':CSRF,'Content-Type':'application/x-www-form-urlencoded'}, body
    });
    const d = await r.json();
    if (d.ok) { location.reload(); }
}

async function submitLog2() {
    const body = new URLSearchParams({
        elapsed_min: document.getElementById('logElapsed2').value,
        temperature_c: document.getElementById('logTemp2').value,
        pressure_bar: document.getElementById('logPressure2').value,
        humidity_pct: document.getElementById('logHumidity2').value,
        phase: document.getElementById('logPhase2').value,
    });
    const r = await fetch(`/heatset/${BATCH_PK}/log/add/`, {
        method:'POST', headers:{'X-CSRFToken':CSRF,'Content-Type':'application/x-www-form-urlencoded'}, body
    });
    const d = await r.json();
    if (d.ok) { location.reload(); }
}

// â”€â”€ Ù†Ù…ÙˆØ¯Ø§Ø± ApexCharts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{% if log_count > 0 %}
fetch(`/heatset/${BATCH_PK}/log/data/`)
    .then(r=>r.json())
    .then(data => {
        if (!data.elapsed || data.elapsed.length === 0) return;
        const opts = {
            chart: { type:'line', height:280, toolbar:{show:false}, fontFamily:'Vazirmatn,sans-serif' },
            series: [
                { name:'Ø¯Ù…Ø§ (Â°C)', data: data.temperature.map((v,i)=>({x:data.elapsed[i],y:v})) },
                { name:'ÙØ´Ø§Ø± (barÃ—10)', data: data.pressure.map((v,i)=>({x:data.elapsed[i],y:v?v*10:null})) },
            ],
            colors: ['#ef4444','#3b82f6'],
            stroke: { curve:'smooth', width:[2,2] },
            xaxis: { type:'numeric', title:{text:'Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø´Ø±ÙˆØ¹'} },
            yaxis: { title:{text:'Ø¯Ù…Ø§ Â°C / ÙØ´Ø§Ø± (Ã—Û±Û°)'} },
            tooltip: { x:{formatter:v=>`${v} Ø¯Ù‚`} },
            legend: { position:'top' },
        };
        new ApexCharts(document.getElementById('cycleChart'), opts).render();
    });
{% endif %}
</script>
{% endblock %}
