{% extends "base.html" %}
{% load static %}

{% block title %}Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡ | Ø¯ÛŒØ§Ú©Ùˆ MES{% endblock %}

{% block extra_css %}
<style>
.floor-map-page { padding: 0; }

/* â”€â”€ KPI Bar â”€â”€ */
.map-kpi-bar {
    display: flex; gap: 8px; padding: 10px 16px;
    flex-wrap: wrap; align-items: center;
    background: #fff; border-bottom: 1px solid #e5e7eb;
}
.map-kpi {
    display: flex; align-items: center; gap: 6px;
    background: #f9fafb; border: 1px solid #e5e7eb;
    border-radius: 8px; padding: 6px 12px; font-size: 0.82rem;
}
.kpi-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.kpi-count { font-weight: 800; font-size: 1rem; margin: 0 3px; }
.dot-good        { background: #22c55e; }
.dot-warning     { background: #eab308; }
.dot-critical    { background: #ef4444; }
.dot-maintenance { background: #f97316; }
.dot-idle        { background: #9ca3af; }
.map-meta { margin-right: auto; display: flex; align-items: center; gap: 12px; font-size: 0.8rem; color: #6b7280; }
.live-badge {
    background: #22c55e; color: #fff; padding: 3px 10px;
    border-radius: 10px; font-size: 0.72rem; font-weight: 700;
    animation: pulse-live 2s infinite;
}
@keyframes pulse-live { 0%,100%{opacity:1} 50%{opacity:0.65} }

/* â”€â”€ SVG wrapper â€” Ø¨Ø¯ÙˆÙ† Ø§Ø³Ú©Ø±ÙˆÙ„ â”€â”€ */
.svg-wrapper {
    background: #0f172a;
    margin: 10px 12px;
    border-radius: 10px;
    padding: 10px;
    /* Ø§Ø±ØªÙØ§Ø¹ Ú©Ø´Ø³Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ viewport */
    max-height: calc(100vh - 160px);
    overflow: hidden;
}
.floor-svg {
    width: 100%;
    height: 100%;
    display: block;
}

/* â”€â”€ Zone â”€â”€ */
.zone-bg       { fill: #1a2235; stroke: #334155; stroke-width: 1.5; stroke-dasharray: 5 3; }
.zone-finish   { fill: #0f2620; stroke: #166534; stroke-width: 1.5; stroke-dasharray: 5 3; }
.zone-qc       { fill: #0d1f3c; stroke: #1e40af; stroke-width: 1.5; stroke-dasharray: 4 2; }
.zone-lab      { fill: #1a0f2e; stroke: #6d28d9; stroke-width: 1.5; stroke-dasharray: 4 2; }
.zone-storage  { fill: #1c1208; stroke: #92400e; stroke-width: 1.5; stroke-dasharray: 5 3; }

.zone-title {
    fill: #94a3b8; font-size: 13px; font-weight: 700;
    font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle;
}
.zone-sub {
    fill: #475569; font-size: 8.5px;
    font-family: 'Consolas', monospace; text-anchor: middle;
}

/* â”€â”€ Machine â”€â”€ */
.machine-rect { cursor: pointer; transition: all 0.2s; }
.machine-rect:hover { filter: brightness(1.3) drop-shadow(0 0 5px currentColor); stroke-width: 3 !important; }
.m-code { font-size: 9px; font-weight: 800; font-family: 'Consolas', monospace; text-anchor: middle; fill: #fff; pointer-events: none; }
.m-eff  { font-size: 8px; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; fill: rgba(255,255,255,0.8); pointer-events: none; }

/* â”€â”€ Heatmap â”€â”€ */
.heat-good        { fill: #16a34a; stroke: #15803d; stroke-width: 1.5; }
.heat-warning     { fill: #ca8a04; stroke: #a16207; stroke-width: 1.5; }
.heat-critical    { fill: #dc2626; stroke: #b91c1c; stroke-width: 1.5; animation: blink-c 1.2s infinite; }
.heat-maintenance { fill: #ea580c; stroke: #c2410c; stroke-width: 1.5; stroke-dasharray: 4 2; }
.heat-idle        { fill: #1e293b; stroke: #334155; stroke-width: 1; }
@keyframes blink-c { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* â”€â”€ Flow arrows â”€â”€ */
.flow { fill: none; stroke: #334155; stroke-width: 1.5; marker-end: url(#ah); }

/* â”€â”€ QC/Lab boxes â”€â”€ */
.qc-box  { fill: #0d1f3c; stroke: #3b82f6; stroke-width: 1.5; }
.lab-box { fill: #1a0f2e; stroke: #8b5cf6; stroke-width: 1.5; }
.qc-t  { fill: #93c5fd; font-size: 9px; font-weight: 700; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }
.lab-t { fill: #c4b5fd; font-size: 9px; font-weight: 700; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }
.qc-s  { fill: #60a5fa; font-size: 7.5px; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }
.lab-s { fill: #a78bfa; font-size: 7.5px; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }

/* â”€â”€ Tooltip â”€â”€ */
.map-tooltip {
    position: fixed; display: none;
    background: #fff; border: 1px solid #d1d5db; border-radius: 10px;
    padding: 12px 16px; min-width: 230px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
    z-index: 9999; font-size: 0.82rem; direction: rtl; pointer-events: none;
}
.map-tooltip.visible { display: block; }
.tt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #f0f0f0; }
.tt-name   { font-weight: 800; color: #111; font-size: 0.9rem; }
.tt-badge  { padding: 2px 9px; border-radius: 5px; font-size: 0.7rem; font-weight: 700; }
.s-good        { background:#dcfce7; color:#166534; }
.s-warning     { background:#fef9c3; color:#854d0e; }
.s-critical    { background:#fee2e2; color:#991b1b; }
.s-maintenance { background:#ffedd5; color:#9a3412; }
.s-idle        { background:#f3f4f6; color:#374151; }
.tt-row { display: flex; justify-content: space-between; padding: 2px 0; }
.tt-k { color:#6b7280; } .tt-v { font-weight:700; color:#111; }

/* â”€â”€ Legend â”€â”€ */
.map-legend {
    display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;
    padding: 8px 12px; font-size: 0.76rem; color: #64748b;
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-box  { width: 14px; height: 9px; border-radius: 2px; }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="row">
    <div class="col-12">
        <div class="page-header">
            <div class="page-header-title">
                <h4 class="mb-0"><i class="ti ti-map-2 text-primary me-2"></i>Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡ â€” Heatmap Ø²Ù†Ø¯Ù‡</h4>
            </div>
            <div class="page-header-breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                    <li class="breadcrumb-item active">Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="floor-map-page">

    <!-- KPI Bar -->
    <div class="map-kpi-bar">
        <div class="map-meta">
            <span class="live-badge">â— Ø²Ù†Ø¯Ù‡</span>
            <span id="meta-date" style="font-weight:600;"></span>
            <span id="meta-shift" style="color:#374151;font-weight:600;"></span>
            <span id="meta-timer" style="font-size:0.73rem;"></span>
        </div>
        <div class="map-kpi"><span class="kpi-dot dot-good"></span>ÙØ¹Ø§Ù„<span class="kpi-count" id="kpi-good">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-warning"></span>Ù‡Ø´Ø¯Ø§Ø±<span class="kpi-count" id="kpi-warning">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-critical"></span>Ø¨Ø­Ø±Ø§Ù†ÛŒ<span class="kpi-count" id="kpi-critical">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-maintenance"></span>ØªØ¹Ù…ÛŒØ±<span class="kpi-count" id="kpi-maintenance">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-idle"></span>Ø®Ø§Ù…ÙˆØ´<span class="kpi-count" id="kpi-idle">0</span></div>
    </div>

    <!-- SVG Map -->
    <div class="svg-wrapper">
        <!--
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        viewBox: 0 0 1000 580  (Ù†Ø³Ø¨Øª Û±Û°:Ûµ.Û¸ â€” Ú©Ø´ÛŒØ¯Ù‡ Ø§ÙÙ‚ÛŒ)
        Ø±Ø¯ÛŒÙ Û± (y=8..290):
          Ø§Ù†Ø¨Ø§Ø±|Ø­Ù„Ø§Ø¬ÛŒ|Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯|Ù¾Ø§Ø³Ø§Ú˜|ÙÛŒÙ†ÛŒØ´Ø±|Ø³Ø§Ù„Ù† Ø±ÛŒÙ†Ú¯
        Ø±Ø¯ÛŒÙ Û² (y=298..570):
          Ø±Ù†Ú¯Ø±Ø²ÛŒ|QC+Lab|Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ|Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ|Ù‡ÛŒØªâ€ŒØ³Øª|Ø§Ù†Ø¨Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        -->
        <svg class="floor-svg" viewBox="0 0 1000 580"
             xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
            <defs>
                <marker id="ah" markerWidth="7" markerHeight="5" refX="6" refY="2.5" orient="auto">
                    <polygon points="0 0,7 2.5,0 5" fill="#475569"/>
                </marker>
                <pattern id="g" width="25" height="25" patternUnits="userSpaceOnUse">
                    <path d="M25 0L0 0 0 25" fill="none" stroke="#1e293b" stroke-width="0.4"/>
                </pattern>
            </defs>

            <!-- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ -->
            <rect width="1000" height="580" fill="url(#g)"/>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø±Ø¯ÛŒÙ Û± â€” Ø±ÛŒØ³Ù†Ø¯Ú¯ÛŒ Ø§ØµÙ„ÛŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <!-- 1. Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡  x=5 w=72 -->
            <rect x="5" y="5" width="72" height="285" class="zone-bg" rx="5"/>
            <text x="41" y="152" class="zone-title" transform="rotate(-90,41,152)">Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</text>
            <text x="41" y="166" class="zone-sub"   transform="rotate(-90,41,166)">RAW STORAGE</text>
            <!-- Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ -->
            <rect x="13" y="18"  width="22" height="14" rx="2" fill="#1a3829" stroke="#2d5a42"/>
            <rect x="40" y="18"  width="22" height="14" rx="2" fill="#1a3829" stroke="#2d5a42"/>
            <rect x="13" y="37"  width="22" height="14" rx="2" fill="#1a3829" stroke="#2d5a42"/>
            <rect x="40" y="37"  width="22" height="14" rx="2" fill="#1a3829" stroke="#2d5a42"/>
            <rect x="13" y="56"  width="22" height="14" rx="2" fill="#1c2f4a" stroke="#2d4a6e"/>
            <rect x="40" y="56"  width="22" height="14" rx="2" fill="#1c2f4a" stroke="#2d4a6e"/>
            <text x="41" y="90"  style="font-size:20px;text-anchor:middle;fill:#334155;">ğŸ“¦</text>
            <!-- ÙÙ„Ø´ -->
            <line x1="77" y1="150" x2="88" y2="150" class="flow"/>

            <!-- 2. Ø­Ù„Ø§Ø¬ÛŒ  x=83 w=115 -->
            <rect x="83" y="5" width="115" height="285" class="zone-bg" rx="5"/>
            <text x="140" y="22" class="zone-title">Ø­Ù„Ø§Ø¬ÛŒ</text>
            <text x="140" y="33" class="zone-sub">BLOWROOM</text>
            <g id="zone-blowroom" data-type="blowroom"></g>
            <line x1="198" y1="150" x2="209" y2="150" class="flow"/>

            <!-- 3. Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯  x=205 w=190 -->
            <rect x="205" y="5" width="190" height="285" class="zone-bg" rx="5"/>
            <text x="300" y="22" class="zone-title">Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯</text>
            <text x="300" y="33" class="zone-sub">CARDING</text>
            <g id="zone-carding" data-type="carding"></g>
            <line x1="395" y1="150" x2="406" y2="150" class="flow"/>

            <!-- 4. Ù¾Ø§Ø³Ø§Ú˜  x=403 w=100 -->
            <rect x="403" y="5" width="100" height="285" class="zone-bg" rx="5"/>
            <text x="453" y="22" class="zone-title">Ù¾Ø§Ø³Ø§Ú˜</text>
            <text x="453" y="33" class="zone-sub">PASSAGE</text>
            <g id="zone-passage" data-type="passage"></g>
            <line x1="503" y1="150" x2="514" y2="150" class="flow"/>

            <!-- 5. ÙÛŒÙ†ÛŒØ´Ø±  x=511 w=100 -->
            <rect x="511" y="5" width="100" height="285" class="zone-bg" rx="5"/>
            <text x="561" y="22" class="zone-title">ÙÛŒÙ†ÛŒØ´Ø±</text>
            <text x="561" y="33" class="zone-sub">ROVING</text>
            <g id="zone-finisher" data-type="finisher"></g>
            <line x1="611" y1="150" x2="622" y2="150" class="flow"/>

            <!-- 6. Ø³Ø§Ù„Ù† Ø±ÛŒÙ†Ú¯  x=619 w=376 -->
            <rect x="619" y="5" width="376" height="285" class="zone-bg" rx="5"/>
            <text x="807" y="22" class="zone-title">Ø³Ø§Ù„Ù† Ø±ÛŒÙ†Ú¯</text>
            <text x="807" y="33" class="zone-sub">RING SPINNING HALL</text>
            <g id="zone-ring" data-type="ring"></g>

            <!-- ÙÙ„Ø´ Ø±ÛŒÙ†Ú¯ â†’ Ù¾Ø§ÛŒÛŒÙ† (Ø±Ø¯ÛŒÙ Û² ØªÚ©Ù…ÛŒÙ„) -->
            <line x1="807" y1="290" x2="807" y2="302" class="flow"/>

            <!-- Ø®Ø· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ -->
            <line x1="5" y1="295" x2="995" y2="295" stroke="#1e3a2e" stroke-width="1.5" stroke-dasharray="8 4"/>
            <text x="500" y="301" style="fill:#166534;font-size:8px;font-weight:700;text-anchor:middle;font-family:'Vazirmatn FD';">â”€â”€ Ø®Ø· ØªÚ©Ù…ÛŒÙ„ Ù†Ø® ÙØ±Ø´: Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ â”€ Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ â”€ Ù‡ÛŒØªâ€ŒØ³Øª â”€â”€</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø±Ø¯ÛŒÙ Û² â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <!-- 7. Ø±Ù†Ú¯Ø±Ø²ÛŒ  x=5 w=140 -->
            <rect x="5" y="305" width="140" height="270" class="zone-bg" rx="5"/>
            <text x="75" y="322" class="zone-title">Ø±Ù†Ú¯Ø±Ø²ÛŒ</text>
            <text x="75" y="333" class="zone-sub">DYEING</text>
            <g id="zone-dyeing" data-type="dyeing"></g>

            <!-- 8. Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª + Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡  x=150 w=200 -->
            <rect x="150" y="305" width="200" height="270" class="zone-qc" rx="5"/>

            <!-- Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§: QC -->
            <text x="250" y="322" class="zone-title" style="fill:#93c5fd;">Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª</text>
            <text x="250" y="333" class="zone-sub" style="fill:#3b82f6;">QUALITY CONTROL</text>

            <rect x="160" y="342" width="44" height="46" class="qc-box" rx="4"/>
            <text x="182" y="357" class="qc-t">QC-01</text>
            <text x="182" y="369" class="qc-s">Ø¢Ø²Ù…ÙˆÙ† Ù†Ù…Ø±Ù‡</text>
            <text x="182" y="381" class="qc-s">Ù†Ø®</text>

            <rect x="210" y="342" width="44" height="46" class="qc-box" rx="4"/>
            <text x="232" y="357" class="qc-t">QC-02</text>
            <text x="232" y="369" class="qc-s">Ø§Ø³ØªØ­Ú©Ø§Ù…</text>
            <text x="232" y="381" class="qc-s">Ú©Ø´Ø´</text>

            <rect x="260" y="342" width="44" height="46" class="qc-box" rx="4"/>
            <text x="282" y="357" class="qc-t">QC-03</text>
            <text x="282" y="369" class="qc-s">ÛŒÚ©Ù†ÙˆØ§Ø®ØªÛŒ</text>
            <text x="282" y="381" class="qc-s">CV%</text>

            <rect x="310" y="342" width="35" height="46" class="qc-box" rx="4"/>
            <text x="327" y="357" class="qc-t">QC-04</text>
            <text x="327" y="369" class="qc-s">Ø±Ù†Ú¯â€Œ</text>
            <text x="327" y="381" class="qc-s">Ø«Ø¨Ø§Øª</text>

            <!-- Ø®Ø· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ QC / Lab -->
            <line x1="155" y1="398" x2="345" y2="398" stroke="#1e3a5f" stroke-width="1.5" stroke-dasharray="4 3"/>

            <!-- Ø¨Ø®Ø´ Ù¾Ø§ÛŒÛŒÙ†: Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡ -->
            <text x="250" y="413" class="zone-title" style="fill:#c4b5fd;">Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡</text>
            <text x="250" y="423" class="zone-sub" style="fill:#6d28d9;">LABORATORY</text>

            <rect x="158" y="432" width="44" height="50" class="lab-box" rx="4"/>
            <text x="180" y="448" class="lab-t">Uster</text>
            <text x="180" y="459" class="lab-t">Tester</text>
            <text x="180" y="472" class="lab-s">ÛŒÚ©Ù†ÙˆØ§Ø®ØªÛŒ</text>

            <rect x="208" y="432" width="44" height="50" class="lab-box" rx="4"/>
            <text x="230" y="448" class="lab-t">Tensile</text>
            <text x="230" y="459" class="lab-t">Tester</text>
            <text x="230" y="472" class="lab-s">Ø§Ø³ØªØ­Ú©Ø§Ù…</text>

            <rect x="258" y="432" width="44" height="50" class="lab-box" rx="4"/>
            <text x="280" y="448" class="lab-t">Twist</text>
            <text x="280" y="459" class="lab-t">Tester</text>
            <text x="280" y="472" class="lab-s">Ø¢Ø²Ù…ÙˆÙ† ØªØ§Ø¨</text>

            <rect x="308" y="432" width="37" height="50" class="lab-box" rx="4"/>
            <text x="326" y="448" class="lab-t">Wrap</text>
            <text x="326" y="459" class="lab-t">Reel</text>
            <text x="326" y="472" class="lab-s">Ù†Ù…Ø±Ù‡â€ŒØ³Ù†Ø¬</text>

            <!-- Ø§ÛŒÙ…Ù†ÛŒ -->
            <rect x="160" y="492" width="185" height="30" rx="4" fill="#0a1628" stroke="#1e3a5f" stroke-width="1"/>
            <text x="252" y="511" style="fill:#475569;font-size:8px;font-family:'Vazirmatn FD';text-anchor:middle;">ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ú©ÛŒÙÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ | Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ù‡Ø± Û² Ø³Ø§Ø¹Øª</text>

            <!-- 9. Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ  x=355 w=155 -->
            <rect x="355" y="305" width="155" height="270" class="zone-finish" rx="5"/>
            <text x="432" y="322" class="zone-title" style="fill:#86efac;">Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ</text>
            <text x="432" y="333" class="zone-sub" style="fill:#15803d;">WINDING</text>
            <g id="zone-winding" data-type="winding"></g>
            <line x1="510" y1="440" x2="521" y2="440" class="flow"/>

            <!-- 10. Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO  x=516 w=155 -->
            <rect x="516" y="305" width="155" height="270" class="zone-finish" rx="5"/>
            <text x="593" y="322" class="zone-title" style="fill:#86efac;">Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO</text>
            <text x="593" y="333" class="zone-sub" style="fill:#15803d;">TWO-FOR-ONE</text>
            <g id="zone-tfo" data-type="tfo"></g>
            <line x1="671" y1="440" x2="682" y2="440" class="flow"/>

            <!-- 11. Ù‡ÛŒØªâ€ŒØ³Øª  x=677 w=155 -->
            <rect x="677" y="305" width="155" height="270" class="zone-finish" rx="5"/>
            <text x="754" y="322" class="zone-title" style="fill:#86efac;">Ù‡ÛŒØªâ€ŒØ³Øª</text>
            <text x="754" y="333" class="zone-sub" style="fill:#15803d;">HEAT SETTING</text>
            <g id="zone-heatset" data-type="heatset"></g>
            <line x1="832" y1="440" x2="843" y2="440" class="flow"/>

            <!-- 12. Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ  x=837 w=158 -->
            <rect x="837" y="305" width="158" height="270" class="zone-storage" rx="5"/>
            <text x="916" y="322" class="zone-title" style="fill:#fbbf24;">Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„</text>
            <text x="916" y="333" class="zone-sub" style="fill:#92400e;">FINISHED GOODS</text>
            <!-- Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù†Ø® -->
            <circle cx="875" cy="390" r="18" fill="none" stroke="#92400e" stroke-width="2.5"/>
            <circle cx="875" cy="390" r="7"  fill="#78350f"/>
            <circle cx="916" cy="390" r="18" fill="none" stroke="#92400e" stroke-width="2.5"/>
            <circle cx="916" cy="390" r="7"  fill="#78350f"/>
            <circle cx="957" cy="390" r="18" fill="none" stroke="#92400e" stroke-width="2.5"/>
            <circle cx="957" cy="390" r="7"  fill="#78350f"/>
            <circle cx="875" cy="432" r="18" fill="none" stroke="#78350f" stroke-width="2.5"/>
            <circle cx="875" cy="432" r="7"  fill="#451a03"/>
            <circle cx="916" cy="432" r="18" fill="none" stroke="#78350f" stroke-width="2.5"/>
            <circle cx="916" cy="432" r="7"  fill="#451a03"/>
            <circle cx="957" cy="432" r="18" fill="none" stroke="#78350f" stroke-width="2.5"/>
            <circle cx="957" cy="432" r="7"  fill="#451a03"/>
            <text x="916" y="475" style="fill:#92400e;font-size:9px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ù…Ø´ØªØ±ÛŒ</text>

            <!-- ÙÙ„Ø´ Ø§Ø² Ø±ÛŒÙ†Ú¯ (Ø±Ø¯ÛŒÙ Û± Ø±Ø§Ø³Øª) Ø¨Ù‡ Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ (Ø±Ø¯ÛŒÙ Û²) -->
            <!-- Ø®Ø· Ø¹Ù…ÙˆØ¯ÛŒ Ø§Ø² Ø±ÛŒÙ†Ú¯ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ù‡ Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ Ø¨Ø§Ù„Ø§ -->
            <line x1="432" y1="290" x2="432" y2="304" class="flow"/>
        </svg>
    </div>

    <!-- Legend -->
    <div class="map-legend">
        <div class="legend-item"><div class="legend-box" style="background:#16a34a;"></div>Ø±Ø§Ù†Ø¯Ù…Ø§Ù† â‰¥ Û¹Û°Ùª</div>
        <div class="legend-item"><div class="legend-box" style="background:#ca8a04;"></div>Û·Û°Ùª â€“ Û¹Û°Ùª</div>
        <div class="legend-item"><div class="legend-box" style="background:#dc2626;"></div>&lt; Û·Û°Ùª / Ù…ØªÙˆÙ‚Ù</div>
        <div class="legend-item"><div class="legend-box" style="background:#ea580c;border:1px dashed;"></div>Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±</div>
        <div class="legend-item"><div class="legend-box" style="background:#1e293b;border:1px solid #334155;"></div>Ø®Ø§Ù…ÙˆØ´</div>
        <div class="legend-item"><div class="legend-box" style="background:#0d1f3c;border:1px solid #3b82f6;"></div>Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª</div>
        <div class="legend-item"><div class="legend-box" style="background:#1a0f2e;border:1px solid #6d28d9;"></div>Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡</div>
        <div class="legend-item"><div class="legend-box" style="background:#0f2620;border:1px solid #166534;"></div>Ø®Ø· ØªÚ©Ù…ÛŒÙ„</div>
    </div>
</div>

<!-- Tooltip -->
<div class="map-tooltip" id="machine-tooltip">
    <div class="tt-header">
        <span class="tt-name" id="tt-name">--</span>
        <span class="tt-badge" id="tt-status">--</span>
    </div>
    <div class="tt-row"><span class="tt-k">Ú©Ø¯</span><span class="tt-v" id="tt-code">--</span></div>
    <div class="tt-row"><span class="tt-k">Ù†ÙˆØ¹</span><span class="tt-v" id="tt-type">--</span></div>
    <div class="tt-row"><span class="tt-k">Ø®Ø·</span><span class="tt-v" id="tt-line">--</span></div>
    <div class="tt-row"><span class="tt-k">Ø´ÛŒÙØª</span><span class="tt-v" id="tt-shift">--</span></div>
    <div class="tt-row"><span class="tt-k">Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</span><span class="tt-v" id="tt-eff">--</span></div>
    <div class="tt-row"><span class="tt-k">ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²</span><span class="tt-v" id="tt-output">--</span></div>
    <div class="tt-row"><span class="tt-k">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ú†</span><span class="tt-v" id="tt-batch">--</span></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    const API_URL = '{% url "dashboard:floor_map_api" %}';
    const REFRESH = 30;
    let countdown = REFRESH;
    let mData = {};

    // â•â•â• Zone config â€” Ù…Ø®ØªØµØ§Øª Ùˆ Ø§Ø¨Ø¹Ø§Ø¯ Ù‡Ø± Ø¨Ø®Ø´ â•â•â•
    // x,y = Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ† Ù…Ø§Ø´ÛŒÙ† | w,h = Ø§Ø¨Ø¹Ø§Ø¯ Ù…Ø§Ø´ÛŒÙ†
    // cols = Ø³ØªÙˆÙ† | gapX = ÙØ§ØµÙ„Ù‡ Ø§ÙÙ‚ÛŒ | gapY = ÙØ§ØµÙ„Ù‡ Ø¹Ù…ÙˆØ¯ÛŒ | maxPerCol = Ø±Ø¯ÛŒÙ Ø¯Ø± Ù‡Ø± Ø³ØªÙˆÙ†
    const ZC = {
        blowroom: { x:95,  y:48,  w:52, h:38, cols:2, gapX:58, gapY:48, maxPerCol:5 },
        carding:  { x:215, y:48,  w:44, h:34, cols:4, gapX:50, gapY:42, maxPerCol:5 },
        passage:  { x:413, y:48,  w:44, h:34, cols:2, gapX:50, gapY:42, maxPerCol:5 },
        finisher: { x:521, y:48,  w:44, h:34, cols:2, gapX:50, gapY:42, maxPerCol:5 },
        ring:     { x:629, y:48,  w:54, h:30, cols:5, gapX:70, gapY:38, maxPerCol:6 },
        winding:  { x:363, y:350, w:54, h:38, cols:2, gapX:65, gapY:50, maxPerCol:4 },
        tfo:      { x:524, y:350, w:54, h:38, cols:2, gapX:65, gapY:50, maxPerCol:4 },
        heatset:  { x:685, y:350, w:54, h:38, cols:2, gapX:65, gapY:50, maxPerCol:4 },
        dyeing:   { x:13,  y:350, w:52, h:36, cols:2, gapX:62, gapY:46, maxPerCol:5 },
    };

    const TYPE_FA = {
        blowroom:'Ø­Ù„Ø§Ø¬ÛŒ', carding:'Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯', passage:'Ù¾Ø§Ø³Ø§Ú˜', finisher:'ÙÛŒÙ†ÛŒØ´Ø±',
        ring:'Ø±ÛŒÙ†Ú¯', winding:'Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ', tfo:'Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO', heatset:'Ù‡ÛŒØªâ€ŒØ³Øª', dyeing:'Ø±Ù†Ú¯Ø±Ø²ÛŒ',
    };
    const STATUS_FA = { good:'ÙØ¹Ø§Ù„', warning:'Ù‡Ø´Ø¯Ø§Ø±', critical:'Ø¨Ø­Ø±Ø§Ù†ÛŒ', maintenance:'ØªØ¹Ù…ÛŒØ±Ø§Øª', idle:'Ø®Ø§Ù…ÙˆØ´' };

    // â•â•â• Init â•â•â•
    fetchData();
    setInterval(tick, 1000);

    function fetchData() {
        fetch(API_URL, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
        .then(r => r.json())
        .then(d => {
            updateKPIs(d.summary);
            document.getElementById('meta-date').textContent = d.jalali_date;
            document.getElementById('meta-shift').textContent = d.shift;
            renderAll(d.machines);
            countdown = REFRESH;
        })
        .catch(e => console.error('API Error:', e));
    }

    function tick() {
        countdown--;
        const el = document.getElementById('meta-timer');
        if (el) el.textContent = countdown <= 0 ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...' : `Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${countdown}s`;
        if (countdown <= 0) fetchData();
    }

    function updateKPIs(s) {
        ['good','warning','critical','maintenance','idle'].forEach(k => {
            const el = document.getElementById('kpi-' + k);
            if (el) el.textContent = s[k] || 0;
        });
    }

    // â•â•â• Render â•â•â•
    function renderAll(machines) {
        // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
        const groups = {};
        machines.forEach(m => {
            mData[m.code] = m;
            if (!groups[m.type]) groups[m.type] = [];
            groups[m.type].push(m);
        });

        Object.keys(ZC).forEach(type => {
            const zone = document.getElementById('zone-' + type);
            if (!zone) return;
            zone.innerHTML = '';
            const c = ZC[type];
            const list = groups[type] || [];

            list.forEach((m, i) => {
                const col = Math.floor(i / c.maxPerCol);
                const row = i % c.maxPerCol;
                const x = c.x + col * c.gapX;
                const y = c.y + row * c.gapY;

                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x); rect.setAttribute('y', y);
                rect.setAttribute('width', c.w); rect.setAttribute('height', c.h);
                rect.setAttribute('class', `machine-rect heat-${m.heat_level}`);
                rect.setAttribute('rx', '5');

                const code = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                code.setAttribute('x', x + c.w / 2);
                code.setAttribute('y', y + c.h / 2 + (m.efficiency > 0 ? 0 : 4));
                code.setAttribute('class', 'm-code');
                code.textContent = m.code;

                g.appendChild(rect);
                g.appendChild(code);

                // Ø±Ø§Ù†Ø¯Ù…Ø§Ù† Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
                if (m.efficiency > 0) {
                    const eff = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    eff.setAttribute('x', x + c.w / 2);
                    eff.setAttribute('y', y + c.h / 2 + 13);
                    eff.setAttribute('class', 'm-eff');
                    eff.textContent = m.efficiency + '%';
                    g.appendChild(eff);
                }

                g.addEventListener('mouseenter', e => showTT(e, m));
                g.addEventListener('mousemove', moveTT);
                g.addEventListener('mouseleave', hideTT);
                zone.appendChild(g);
            });
        });
    }

    // â•â•â• Tooltip â•â•â•
    const TT = document.getElementById('machine-tooltip');

    function showTT(e, m) {
        const f = mData[m.code] || m;
        document.getElementById('tt-name').textContent   = f.name;
        document.getElementById('tt-code').textContent   = f.code;
        document.getElementById('tt-type').textContent   = TYPE_FA[f.type] || f.type;
        document.getElementById('tt-line').textContent   = f.line_code;
        document.getElementById('tt-shift').textContent  = f.shift;
        document.getElementById('tt-eff').textContent    = f.efficiency > 0 ? f.efficiency + '%' : 'â€”';
        document.getElementById('tt-output').textContent = f.output_kg > 0
            ? (+f.output_kg).toLocaleString('fa-IR', {maximumFractionDigits:1}) + ' kg' : 'â€”';
        document.getElementById('tt-batch').textContent  = f.last_batch || 'â€”';
        const s = document.getElementById('tt-status');
        s.className = 'tt-badge s-' + f.heat_level;
        s.textContent = STATUS_FA[f.heat_level] || 'â€”';
        TT.classList.add('visible');
        moveTT(e);
    }
    function moveTT(e) {
        let x = e.clientX + 16, y = e.clientY + 16;
        if (x + 250 > window.innerWidth)  x = e.clientX - 255;
        if (y + 230 > window.innerHeight) y = e.clientY - 230;
        TT.style.left = x + 'px';
        TT.style.top  = y + 'px';
    }
    function hideTT() { TT.classList.remove('visible'); }

})();
</script>
{% endblock %}
