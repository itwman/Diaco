{% extends "base.html" %}
{% load static %}

{% block title %}Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡ | Ø¯ÛŒØ§Ú©Ùˆ MES{% endblock %}

{% block extra_css %}
<style>
.floor-map-page { padding: 0; }

/* â”€â”€ KPI Bar â”€â”€ */
.map-kpi-bar {
    display: flex; gap: 10px; padding: 14px 20px;
    flex-wrap: wrap; align-items: center; background: #fff;
    border-bottom: 1px solid #e5e7eb;
}
.map-kpi {
    display: flex; align-items: center; gap: 8px;
    background: #f9fafb; border: 1px solid #e5e7eb;
    border-radius: 10px; padding: 7px 14px; font-size: 0.83rem;
}
.kpi-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
.kpi-count { font-weight: 800; font-size: 1.05rem; margin: 0 3px; }
.dot-good       { background: #22c55e; }
.dot-warning    { background: #eab308; }
.dot-critical   { background: #ef4444; }
.dot-maintenance{ background: #f97316; }
.dot-idle       { background: #9ca3af; }
.map-meta { margin-right: auto; display: flex; align-items: center; gap: 14px; font-size: 0.83rem; color: #6b7280; }
.live-badge {
    background: #22c55e; color: #fff; padding: 3px 11px;
    border-radius: 12px; font-size: 0.73rem; font-weight: 700;
    animation: pulse-live 2s infinite;
}
@keyframes pulse-live { 0%,100%{opacity:1} 50%{opacity:0.7} }

/* â”€â”€ SVG wrapper â”€â”€ */
.svg-wrapper {
    background: #111827; border-radius: 10px;
    margin: 12px 16px; padding: 12px;
    overflow-x: auto; overflow-y: hidden;
}
.floor-svg { width: 100%; min-width: 1500px; height: auto; display: block; }

/* â”€â”€ Zone styles â”€â”€ */
.zone-bg    { fill: #1a2235; stroke: #2d3f5c; stroke-width: 1.5; stroke-dasharray: 6 3; }
.zone-bg-qc { fill: #1a2030; stroke: #3d4a6c; stroke-width: 1.5; stroke-dasharray: 4 2; }
.zone-bg-finish { fill: #1c2030; stroke: #3b5f3b; stroke-width: 1.5; stroke-dasharray: 6 3; }
.zone-label {
    fill: #94a3b8; font-size: 11px; font-weight: 700;
    font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle;
}
.zone-label-en {
    fill: #4a5568; font-size: 7.5px;
    font-family: 'Consolas', monospace; text-anchor: middle;
}
.zone-icon { fill: #475569; font-size: 14px; text-anchor: middle; }

/* â”€â”€ Machine â”€â”€ */
.machine-rect { rx: 4; ry: 4; stroke-width: 1.5; cursor: pointer; transition: all 0.25s; }
.machine-rect:hover { stroke-width: 3; filter: brightness(1.25) drop-shadow(0 0 6px currentColor); }
.machine-code { font-size: 6.5px; font-weight: 700; font-family: 'Consolas', monospace; text-anchor: middle; fill: #fff; pointer-events: none; }
.machine-name { font-size: 5.5px; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; fill: rgba(255,255,255,0.7); pointer-events: none; }

/* â”€â”€ Heatmap colors â”€â”€ */
.heat-good        { fill: #16a34a; stroke: #15803d; }
.heat-warning     { fill: #ca8a04; stroke: #a16207; }
.heat-critical    { fill: #dc2626; stroke: #b91c1c; animation: blink-c 1.2s infinite; }
.heat-maintenance { fill: #ea580c; stroke: #c2410c; stroke-dasharray: 4 2; }
.heat-idle        { fill: #1f2937; stroke: #374151; }

@keyframes blink-c { 0%,100%{opacity:1} 50%{opacity:0.45} }

/* â”€â”€ Flow arrows â”€â”€ */
.flow-line { fill: none; stroke: #334155; stroke-width: 1.2; marker-end: url(#ah); }
.flow-label { fill: #475569; font-size: 7px; font-family: 'Consolas', monospace; text-anchor: middle; }

/* â”€â”€ QC / Lab special â”€â”€ */
.qc-box { fill: #1e3a5f; stroke: #3b82f6; stroke-width: 1.5; }
.qc-label { fill: #93c5fd; font-size: 9px; font-weight: 700; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }
.lab-box  { fill: #1e3040; stroke: #8b5cf6; stroke-width: 1.5; }
.lab-label{ fill: #c4b5fd; font-size: 9px; font-weight: 700; font-family: 'Vazirmatn FD', sans-serif; text-anchor: middle; }

/* â”€â”€ Tooltip â”€â”€ */
.map-tooltip {
    position: fixed; display: none;
    background: #fff; border: 1px solid #d1d5db;
    border-radius: 12px; padding: 14px 18px;
    min-width: 240px; max-width: 280px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000; font-size: 0.83rem; direction: rtl; pointer-events: none;
}
.map-tooltip.visible { display: block; }
.tt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; }
.tt-name  { font-weight: 800; font-size: 0.92rem; color: #111827; }
.tt-status{ padding: 2px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
.tt-status-good        { background: #dcfce7; color: #166534; }
.tt-status-warning     { background: #fef9c3; color: #854d0e; }
.tt-status-critical    { background: #fee2e2; color: #991b1b; }
.tt-status-maintenance { background: #ffedd5; color: #9a3412; }
.tt-status-idle        { background: #f3f4f6; color: #374151; }
.tt-row { display: flex; justify-content: space-between; padding: 3px 0; }
.tt-key { color: #6b7280; }
.tt-val { font-weight: 700; color: #111827; }

/* â”€â”€ Legend â”€â”€ */
.map-legend { display: flex; gap: 14px; justify-content: center; padding: 10px; font-size: 0.78rem; color: #64748b; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-box  { width: 16px; height: 10px; border-radius: 3px; }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="row">
    <div class="col-12">
        <div class="page-header">
            <div class="page-header-title">
                <h4 class="mb-0"><i class="ti ti-map-2 text-primary me-2"></i>Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡ - Heatmap Ø²Ù†Ø¯Ù‡</h4>
            </div>
            <div class="page-header-breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                    <li class="breadcrumb-item active">Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ú¯Ø§Ù‡</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="floor-map-page">

    <!-- â”€â”€ KPI Bar â”€â”€ -->
    <div class="map-kpi-bar">
        <div class="map-meta">
            <span class="live-badge">â— Ø²Ù†Ø¯Ù‡</span>
            <span id="meta-date">--</span>
            <span id="meta-shift">--</span>
            <span id="meta-timer" class="text-muted" style="font-size:0.75rem;">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§ Û³Û° Ø«Ø§Ù†ÛŒÙ‡</span>
        </div>
        <div class="map-kpi"><span class="kpi-dot dot-good"></span>ÙØ¹Ø§Ù„:<span class="kpi-count" id="kpi-good">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-warning"></span>Ù‡Ø´Ø¯Ø§Ø±:<span class="kpi-count" id="kpi-warning">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-critical"></span>Ø¨Ø­Ø±Ø§Ù†ÛŒ:<span class="kpi-count" id="kpi-critical">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-maintenance"></span>ØªØ¹Ù…ÛŒØ±:<span class="kpi-count" id="kpi-maintenance">0</span></div>
        <div class="map-kpi"><span class="kpi-dot dot-idle"></span>Ø®Ø§Ù…ÙˆØ´:<span class="kpi-count" id="kpi-idle">0</span></div>
    </div>

    <!-- â”€â”€ SVG Floor Map â”€â”€ -->
    <div class="svg-wrapper">
        <!--
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  Ú†ÛŒØ¯Ù…Ø§Ù† Ú©Ø§Ø±Ú¯Ø§Ù‡ Ø¯ÛŒØ§Ú©Ùˆ MES â€” Ù†Ù‚Ø´Ù‡ Ú©Ø§Ù…Ù„                           â•‘
            â•‘  viewBox: 0 0 1600 700                                           â•‘
            â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
            â•‘  Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§: Ø§Ù†Ø¨Ø§Ø± | Ø­Ù„Ø§Ø¬ÛŒ | Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯ | Ù¾Ø§Ø³Ø§Ú˜ | ÙÛŒÙ†ÛŒØ´Ø± | Ø±ÛŒÙ†Ú¯   â•‘
            â•‘  Ø±Ø¯ÛŒÙ ÙˆØ³Ø·: â”€â”€â”€ Ø®Ø· ØªÚ©Ù…ÛŒÙ„ Ù†Ø® ÙØ±Ø´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
            â•‘  Ø¨Ø®Ø´ ØªÚ©Ù…ÛŒÙ„: Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ | Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ | Ù‡ÛŒØªâ€ŒØ³Øª                     â•‘
            â•‘  Ø±Ø¯ÛŒÙ Ù¾Ø§ÛŒÛŒÙ†: Ø±Ù†Ú¯Ø±Ø²ÛŒ | Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª | Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡ | Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„  â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        -->
        <svg class="floor-svg" viewBox="0 0 1600 700" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="ah" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                    <polygon points="0 0,8 3,0 6" fill="#475569"/>
                </marker>
                <marker id="ah-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                    <polygon points="0 0,8 3,0 6" fill="#3b82f6"/>
                </marker>
                <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
                    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#1f2937" stroke-width="0.4"/>
                </pattern>
            </defs>

            <!-- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ -->
            <rect width="1600" height="700" fill="url(#grid)" opacity="0.6"/>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§ â€” Ø®Ø· Ø±ÛŒØ³Ù†Ø¯Ú¯ÛŒ Ø§ØµÙ„ÛŒ (y=10 h=310)                   -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <!-- 1. Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ -->
            <rect x="8" y="8" width="95" height="310" class="zone-bg" rx="6"/>
            <text x="55" y="170" class="zone-label" transform="rotate(-90,55,170)">Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</text>
            <text x="55" y="188" class="zone-label-en" transform="rotate(-90,55,188)">RAW STORAGE</text>
            <!-- Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§Ù„ÛŒØ§Ù Ù†Ù…Ø§Ø¯ÛŒÙ† -->
            <rect x="18" y="30"  width="28" height="16" rx="2" fill="#1f3b2f" stroke="#2d5a42"/>
            <rect x="52" y="30"  width="28" height="16" rx="2" fill="#1f3b2f" stroke="#2d5a42"/>
            <rect x="18" y="52"  width="28" height="16" rx="2" fill="#1f3b2f" stroke="#2d5a42"/>
            <rect x="52" y="52"  width="28" height="16" rx="2" fill="#1f3b2f" stroke="#2d5a42"/>
            <rect x="18" y="74"  width="28" height="16" rx="2" fill="#243b50" stroke="#2d5a6e"/>
            <rect x="52" y="74"  width="28" height="16" rx="2" fill="#243b50" stroke="#2d5a6e"/>
            <rect x="18" y="96"  width="28" height="16" rx="2" fill="#243b50" stroke="#2d5a6e"/>
            <rect x="52" y="96"  width="28" height="16" rx="2" fill="#243b50" stroke="#2d5a6e"/>
            <text x="55" y="130" class="zone-icon">ğŸ“¦</text>

            <!-- ÙÙ„Ø´ Ø§Ù†Ø¨Ø§Ø± â†’ Ø­Ù„Ø§Ø¬ÛŒ -->
            <line x1="103" y1="160" x2="118" y2="160" class="flow-line"/>

            <!-- 2. Ø­Ù„Ø§Ø¬ÛŒ -->
            <rect x="108" y="8" width="130" height="310" class="zone-bg" rx="6"/>
            <text x="173" y="26" class="zone-label">Ø­Ù„Ø§Ø¬ÛŒ</text>
            <text x="173" y="37" class="zone-label-en">BLOWROOM</text>
            <g id="zone-blowroom" data-type="blowroom"></g>

            <!-- ÙÙ„Ø´ Ø­Ù„Ø§Ø¬ÛŒ â†’ Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯ -->
            <line x1="238" y1="160" x2="253" y2="160" class="flow-line"/>

            <!-- 3. Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯ -->
            <rect x="248" y="8" width="230" height="310" class="zone-bg" rx="6"/>
            <text x="363" y="26" class="zone-label">Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯</text>
            <text x="363" y="37" class="zone-label-en">CARDING</text>
            <g id="zone-carding" data-type="carding"></g>

            <!-- ÙÙ„Ø´ Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯ â†’ Ù¾Ø§Ø³Ø§Ú˜ -->
            <line x1="478" y1="160" x2="493" y2="160" class="flow-line"/>

            <!-- 4. Ù¾Ø§Ø³Ø§Ú˜ -->
            <rect x="488" y="8" width="120" height="310" class="zone-bg" rx="6"/>
            <text x="548" y="26" class="zone-label">Ù¾Ø§Ø³Ø§Ú˜</text>
            <text x="548" y="37" class="zone-label-en">PASSAGE / DRAWING</text>
            <g id="zone-passage" data-type="passage"></g>

            <!-- ÙÙ„Ø´ Ù¾Ø§Ø³Ø§Ú˜ â†’ ÙÛŒÙ†ÛŒØ´Ø± -->
            <line x1="608" y1="160" x2="623" y2="160" class="flow-line"/>

            <!-- 5. ÙÛŒÙ†ÛŒØ´Ø± -->
            <rect x="618" y="8" width="120" height="310" class="zone-bg" rx="6"/>
            <text x="678" y="26" class="zone-label">ÙÛŒÙ†ÛŒØ´Ø±</text>
            <text x="678" y="37" class="zone-label-en">ROVING / FINISHER</text>
            <g id="zone-finisher" data-type="finisher"></g>

            <!-- ÙÙ„Ø´ ÙÛŒÙ†ÛŒØ´Ø± â†’ Ø±ÛŒÙ†Ú¯ -->
            <line x1="738" y1="160" x2="753" y2="160" class="flow-line"/>

            <!-- 6. Ø³Ø§Ù„Ù† Ø±ÛŒÙ†Ú¯ (Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´) -->
            <rect x="748" y="8" width="490" height="310" class="zone-bg" rx="6"/>
            <text x="993" y="26" class="zone-label">Ø³Ø§Ù„Ù† Ø±ÛŒÙ†Ú¯</text>
            <text x="993" y="37" class="zone-label-en">RING SPINNING HALL</text>
            <g id="zone-ring" data-type="ring"></g>

            <!-- ÙÙ„Ø´ Ø±ÛŒÙ†Ú¯ â†’ Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ (Ø¹Ù…ÙˆØ¯ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†) -->
            <line x1="993" y1="318" x2="993" y2="338" class="flow-line"/>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø±Ø¯ÛŒÙ ÙˆØ³Ø· â€” Ø¨Ø®Ø´ ØªÚ©Ù…ÛŒÙ„ Ù†Ø® ÙØ±Ø´ (y=345 h=185)                  -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <!-- Ø¨Ø±Ú†Ø³Ø¨ Ø±Ø¯ÛŒÙ ØªÚ©Ù…ÛŒÙ„ -->
            <rect x="748" y="340" width="490" height="8" rx="0" fill="#1e3a2e" opacity="0.7"/>
            <text x="993" y="347" class="flow-label" fill="#4ade80" style="font-size:8px;font-weight:700;">â”€â”€ Ø®Ø· ØªÚ©Ù…ÛŒÙ„ Ù†Ø® ÙØ±Ø´ â”€â”€</text>

            <!-- 7. Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ (Winding) -->
            <rect x="748" y="348" width="155" height="185" class="zone-bg-finish" rx="6"/>
            <text x="825" y="366" class="zone-label" style="fill:#86efac;">Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ</text>
            <text x="825" y="377" class="zone-label-en">WINDING</text>
            <g id="zone-winding" data-type="winding"></g>

            <!-- ÙÙ„Ø´ Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ â†’ Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ -->
            <line x1="903" y1="440" x2="918" y2="440" class="flow-line"/>

            <!-- 8. Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO -->
            <rect x="913" y="348" width="155" height="185" class="zone-bg-finish" rx="6"/>
            <text x="990" y="366" class="zone-label" style="fill:#86efac;">Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO</text>
            <text x="990" y="377" class="zone-label-en">TWO-FOR-ONE TWIST</text>
            <g id="zone-tfo" data-type="tfo"></g>

            <!-- ÙÙ„Ø´ TFO â†’ Ù‡ÛŒØªâ€ŒØ³Øª -->
            <line x1="1068" y1="440" x2="1083" y2="440" class="flow-line"/>

            <!-- 9. Ù‡ÛŒØªâ€ŒØ³Øª -->
            <rect x="1078" y="348" width="160" height="185" class="zone-bg-finish" rx="6"/>
            <text x="1158" y="366" class="zone-label" style="fill:#86efac;">Ù‡ÛŒØªâ€ŒØ³Øª</text>
            <text x="1158" y="377" class="zone-label-en">HEAT SETTING</text>
            <g id="zone-heatset" data-type="heatset"></g>

            <!-- ÙÙ„Ø´ Ù‡ÛŒØªâ€ŒØ³Øª â†’ Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„ -->
            <line x1="1238" y1="440" x2="1253" y2="440" class="flow-line"/>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø±Ø¯ÛŒÙ Ú†Ù¾ Ù¾Ø§ÛŒÛŒÙ† â€” Ø±Ù†Ú¯Ø±Ø²ÛŒ (y=348 h=185)                        -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="8" y="348" width="260" height="185" class="zone-bg" rx="6"/>
            <text x="138" y="366" class="zone-label">Ø±Ù†Ú¯Ø±Ø²ÛŒ</text>
            <text x="138" y="377" class="zone-label-en">DYEING SECTION</text>
            <g id="zone-dyeing" data-type="dyeing"></g>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø±Ø¯ÛŒÙ ÙˆØ³Ø· Ù¾Ø§ÛŒÛŒÙ† â€” Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª (y=348)                        -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="278" y="348" width="235" height="85" class="zone-bg-qc" rx="6"/>
            <text x="395" y="364" class="zone-label" style="fill:#93c5fd;">Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª</text>
            <text x="395" y="374" class="zone-label-en">QUALITY CONTROL</text>

            <!-- Ø§ÛŒØ³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ QC -->
            <!-- QC-01 -->
            <rect x="295" y="385" width="45" height="32" class="qc-box" rx="4"/>
            <text x="317" y="397" class="qc-label" style="font-size:7px;">QC-01</text>
            <text x="317" y="408" style="fill:#93c5fd;font-size:5.5px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø¢Ø²Ù…ÙˆÙ† Ù†Ù…Ø±Ù‡</text>
            <!-- QC-02 -->
            <rect x="348" y="385" width="45" height="32" class="qc-box" rx="4"/>
            <text x="370" y="397" class="qc-label" style="font-size:7px;">QC-02</text>
            <text x="370" y="408" style="fill:#93c5fd;font-size:5.5px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø§Ø³ØªØ­Ú©Ø§Ù…</text>
            <!-- QC-03 -->
            <rect x="401" y="385" width="45" height="32" class="qc-box" rx="4"/>
            <text x="423" y="397" class="qc-label" style="font-size:7px;">QC-03</text>
            <text x="423" y="408" style="fill:#93c5fd;font-size:5.5px;text-anchor:middle;font-family:'Vazirmatn FD';">ÛŒÚ©Ù†ÙˆØ§Ø®ØªÛŒ</text>
            <!-- QC-04 -->
            <rect x="454" y="385" width="45" height="32" class="qc-box" rx="4"/>
            <text x="476" y="397" class="qc-label" style="font-size:7px;">QC-04</text>
            <text x="476" y="408" style="fill:#93c5fd;font-size:5.5px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø±Ù†Ú¯â€ŒØ«Ø¨Ø§Øª</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡ (y=443)                                            -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="278" y="443" width="235" height="90" class="zone-bg-qc" rx="6" style="stroke:#8b5cf6;"/>
            <text x="395" y="459" class="zone-label" style="fill:#c4b5fd;">Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡</text>
            <text x="395" y="469" class="zone-label-en">LABORATORY</text>

            <!-- ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡ -->
            <!-- Uster Tester -->
            <rect x="293" y="476" width="52" height="42" class="lab-box" rx="4"/>
            <text x="319" y="490" class="lab-label" style="font-size:6.5px;">Uster</text>
            <text x="319" y="500" class="lab-label" style="font-size:6.5px;">Tester</text>
            <text x="319" y="512" style="fill:#a78bfa;font-size:5px;text-anchor:middle;">ÛŒÚ©Ù†ÙˆØ§Ø®ØªÛŒ Ù†Ø®</text>
            <!-- Tensile Tester -->
            <rect x="353" y="476" width="52" height="42" class="lab-box" rx="4"/>
            <text x="379" y="490" class="lab-label" style="font-size:6.5px;">Tensile</text>
            <text x="379" y="500" class="lab-label" style="font-size:6.5px;">Tester</text>
            <text x="379" y="512" style="fill:#a78bfa;font-size:5px;text-anchor:middle;">Ø§Ø³ØªØ­Ú©Ø§Ù…</text>
            <!-- Twist Tester -->
            <rect x="413" y="476" width="52" height="42" class="lab-box" rx="4"/>
            <text x="439" y="490" class="lab-label" style="font-size:6.5px;">Twist</text>
            <text x="439" y="500" class="lab-label" style="font-size:6.5px;">Tester</text>
            <text x="439" y="512" style="fill:#a78bfa;font-size:5px;text-anchor:middle;">Ø¢Ø²Ù…ÙˆÙ† ØªØ§Ø¨</text>
            <!-- Wrap Reel -->
            <rect x="473" y="476" width="33" height="42" class="lab-box" rx="4"/>
            <text x="489" y="490" class="lab-label" style="font-size:6px;">Wrap</text>
            <text x="489" y="500" class="lab-label" style="font-size:6px;">Reel</text>
            <text x="489" y="512" style="fill:#a78bfa;font-size:5px;text-anchor:middle;">Ù†Ù…Ø±Ù‡â€ŒØ³Ù†Ø¬</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ (Ú¯ÙˆØ´Ù‡ Ø±Ø§Ø³Øª Ù¾Ø§ÛŒÛŒÙ†)                          -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="1248" y="348" width="340" height="185" class="zone-bg" rx="6"/>
            <text x="1418" y="366" class="zone-label" style="fill:#fbbf24;">Ø§Ù†Ø¨Ø§Ø± Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ</text>
            <text x="1418" y="377" class="zone-label-en">FINISHED GOODS WAREHOUSE</text>
            <!-- Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù†Ø® Ù†Ù…Ø§Ø¯ÛŒÙ† -->
            <circle cx="1290" cy="420" r="12" fill="none" stroke="#ca8a04" stroke-width="2"/>
            <circle cx="1290" cy="420" r="5"  fill="#78350f"/>
            <text x="1290" y="443" style="fill:#ca8a04;font-size:6px;text-anchor:middle;">Ø¨ÙˆØ¨ÛŒÙ† Ù†Ø®</text>
            <circle cx="1320" cy="420" r="12" fill="none" stroke="#ca8a04" stroke-width="2"/>
            <circle cx="1320" cy="420" r="5"  fill="#78350f"/>
            <circle cx="1350" cy="420" r="12" fill="none" stroke="#ca8a04" stroke-width="2"/>
            <circle cx="1350" cy="420" r="5"  fill="#78350f"/>
            <circle cx="1380" cy="420" r="12" fill="none" stroke="#ca8a04" stroke-width="2"/>
            <circle cx="1380" cy="420" r="5"  fill="#78350f"/>
            <circle cx="1290" cy="460" r="12" fill="none" stroke="#854d0e" stroke-width="2"/>
            <circle cx="1290" cy="460" r="5"  fill="#78350f"/>
            <circle cx="1320" cy="460" r="12" fill="none" stroke="#854d0e" stroke-width="2"/>
            <circle cx="1320" cy="460" r="5"  fill="#78350f"/>
            <circle cx="1350" cy="460" r="12" fill="none" stroke="#854d0e" stroke-width="2"/>
            <circle cx="1350" cy="460" r="5"  fill="#78350f"/>
            <circle cx="1380" cy="460" r="12" fill="none" stroke="#854d0e" stroke-width="2"/>
            <circle cx="1380" cy="460" r="5"  fill="#78350f"/>
            <text x="1335" y="495" class="zone-icon" style="font-size:22px;">ğŸ“¦</text>
            <text x="1418" y="500" class="zone-label-en" style="fill:#92400e;font-size:8px;">Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø§ØªØ§Ù‚ Ú©Ù†ØªØ±Ù„ Ùˆ Ø³ÛŒØ³ØªÙ… MES (Ú¯ÙˆØ´Ù‡ Ø±Ø§Ø³Øª Ø¨Ø§Ù„Ø§)                     -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="1248" y="8" width="340" height="120" class="zone-bg-qc" rx="6"/>
            <text x="1418" y="24" class="zone-label" style="fill:#34d399;">Ø§ØªØ§Ù‚ Ú©Ù†ØªØ±Ù„ MES</text>
            <text x="1418" y="35" class="zone-label-en">MES CONTROL ROOM</text>
            <!-- Ù†Ù…Ø§ÛŒØ´Ú¯Ø±Ù‡Ø§ -->
            <rect x="1265" y="44" width="50" height="32" rx="3" fill="#0f172a" stroke="#10b981" stroke-width="1.5"/>
            <text x="1290" y="62" style="fill:#10b981;font-size:6px;text-anchor:middle;font-family:Consolas;">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</text>
            <rect x="1325" y="44" width="50" height="32" rx="3" fill="#0f172a" stroke="#10b981" stroke-width="1.5"/>
            <text x="1350" y="62" style="fill:#10b981;font-size:6px;text-anchor:middle;font-family:Consolas;">Ù‡ÛŒØªÙ…Ù¾</text>
            <rect x="1385" y="44" width="50" height="32" rx="3" fill="#0f172a" stroke="#10b981" stroke-width="1.5"/>
            <text x="1410" y="62" style="fill:#10b981;font-size:6px;text-anchor:middle;font-family:Consolas;">Ú¯Ø²Ø§Ø±Ø´</text>
            <rect x="1445" y="44" width="50" height="32" rx="3" fill="#0f172a" stroke="#10b981" stroke-width="1.5"/>
            <text x="1470" y="62" style="fill:#10b981;font-size:6px;text-anchor:middle;font-family:Consolas;">Ù‡Ø´Ø¯Ø§Ø±</text>
            <text x="1418" y="100" style="fill:#059669;font-size:7px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø³ÛŒØ³ØªÙ… Ø¯ÛŒØ§Ú©Ùˆ MES â€” Ù¾Ø§Ø±Ú© Ø¹Ù„Ù… Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ Ú©Ø§Ø´Ø§Ù†</text>
            <text x="1418" y="113" style="fill:#047857;font-size:6px;text-anchor:middle;font-family:Consolas;">Diaco MES v2.0 | Real-time Monitoring</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  Ø±Ø¯ÛŒÙ Ø§Ù†ØªÙ‚Ø§Ù„ (Ø§ØªØµØ§Ù„ Ø±ÛŒÙ†Ú¯ â†’ Ø±Ù†Ú¯Ø±Ø²ÛŒ)                            -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <rect x="1248" y="138" width="340" height="175" class="zone-bg" rx="6"/>
            <text x="1418" y="155" class="zone-label" style="fill:#94a3b8;">Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ùˆ ØªØ¹Ù…ÛŒØ±Ø§Øª</text>
            <text x="1418" y="165" class="zone-label-en">MAINTENANCE WORKSHOP</text>
            <!-- Ø§Ø¨Ø²Ø§Ø± Ù†Ù…Ø§Ø¯ÛŒÙ† -->
            <text x="1310" y="230" style="fill:#475569;font-size:30px;text-anchor:middle;">ğŸ”§</text>
            <text x="1390" y="230" style="fill:#475569;font-size:30px;text-anchor:middle;">âš™ï¸</text>
            <text x="1470" y="230" style="fill:#475569;font-size:30px;text-anchor:middle;">ğŸ”©</text>
            <text x="1418" y="270" style="fill:#374151;font-size:8px;text-anchor:middle;font-family:'Vazirmatn FD';">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ PM | WO | ØªÙˆÙ‚ÙØ§Øª</text>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- ÙÙ„Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø±ÛŒØ§Ù† Ø§ØµÙ„ÛŒ Ùˆ Ø¨Ø±Ú†Ø³Ø¨ Ù…Ø±Ø§Ø­Ù„                              -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Ø¨Ø±Ú†Ø³Ø¨ Ø¬Ø±ÛŒØ§Ù† Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§ -->
            <text x="550" y="670" class="flow-label" style="fill:#64748b;font-size:8px;text-anchor:middle;">
                Ø¬Ø±ÛŒØ§Ù† Ø±ÛŒØ³Ù†Ø¯Ú¯ÛŒ: Ø§Ù†Ø¨Ø§Ø± â† Ø­Ù„Ø§Ø¬ÛŒ â† Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯ â† Ù¾Ø§Ø³Ø§Ú˜ â† ÙÛŒÙ†ÛŒØ´Ø± â† Ø±ÛŒÙ†Ú¯
            </text>
            <text x="1020" y="670" class="flow-label" style="fill:#4ade80;font-size:8px;text-anchor:middle;">
                Ø®Ø· ØªÚ©Ù…ÛŒÙ„ ÙØ±Ø´: Ø±ÛŒÙ†Ú¯ â† Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ â† Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ TFO â† Ù‡ÛŒØªâ€ŒØ³Øª â† Ø§Ù†Ø¨Ø§Ø±
            </text>

            <!-- Ø®Ø· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ -->
            <line x1="8" y1="338" x2="1242" y2="338" stroke="#1e3a2e" stroke-width="1.5" stroke-dasharray="8 4"/>

            <!-- ÙÙ„Ø´ Ø±Ù†Ú¯Ø±Ø²ÛŒ â† Ù†Ø® Ø±ÛŒÙ†Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) -->
            <line x1="138" y1="318" x2="138" y2="343" class="flow-line"/>
        </svg>
    </div>

    <!-- â”€â”€ Legend â”€â”€ -->
    <div class="map-legend">
        <div class="legend-item"><div class="legend-box" style="background:#16a34a;"></div>Ø±Ø§Ù†Ø¯Ù…Ø§Ù† â‰¥ Û¹Û°Ùª</div>
        <div class="legend-item"><div class="legend-box" style="background:#ca8a04;"></div>Û·Û°Ùª â€“ Û¹Û°Ùª</div>
        <div class="legend-item"><div class="legend-box" style="background:#dc2626;"></div>&lt; Û·Û°Ùª / Ù…ØªÙˆÙ‚Ù</div>
        <div class="legend-item"><div class="legend-box" style="background:#ea580c;border:1px dashed;"></div>Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±</div>
        <div class="legend-item"><div class="legend-box" style="background:#1f2937;border:1px solid #374151;"></div>Ø®Ø§Ù…ÙˆØ´</div>
        <div class="legend-item"><div class="legend-box" style="background:#1e3a5f;border:1px solid #3b82f6;"></div>Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª</div>
        <div class="legend-item"><div class="legend-box" style="background:#1e3040;border:1px solid #8b5cf6;"></div>Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡</div>
        <div class="legend-item"><div class="legend-box" style="background:#1c2030;border:1px solid #3b5f3b;"></div>Ø®Ø· ØªÚ©Ù…ÛŒÙ„ ÙØ±Ø´</div>
    </div>
</div>

<!-- â”€â”€ Tooltip â”€â”€ -->
<div class="map-tooltip" id="machine-tooltip">
    <div class="tt-header">
        <span class="tt-name" id="tt-name">--</span>
        <span class="tt-status" id="tt-status">--</span>
    </div>
    <div class="tt-row"><span class="tt-key">Ú©Ø¯ Ù…Ø§Ø´ÛŒÙ†</span><span class="tt-val" id="tt-code">--</span></div>
    <div class="tt-row"><span class="tt-key">Ù†ÙˆØ¹</span><span class="tt-val" id="tt-type">--</span></div>
    <div class="tt-row"><span class="tt-key">Ø®Ø· ØªÙˆÙ„ÛŒØ¯</span><span class="tt-val" id="tt-line">--</span></div>
    <div class="tt-row"><span class="tt-key">Ø´ÛŒÙØª</span><span class="tt-val" id="tt-shift">--</span></div>
    <div class="tt-row"><span class="tt-key">Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</span><span class="tt-val" id="tt-eff">--</span></div>
    <div class="tt-row"><span class="tt-key">ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²</span><span class="tt-val" id="tt-output">--</span></div>
    <div class="tt-row"><span class="tt-key">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ú†</span><span class="tt-val" id="tt-batch">--</span></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    const API_URL = '{% url "dashboard:floor_map_api" %}';
    const REFRESH = 30;
    let countdown = REFRESH;
    let machineDataMap = {};

    // â•â•â• ZONE CONFIG â•â•â•
    // Ù‡Ø± zone: {x, y, w, h, cols, gapX, gapY, maxPerCol}
    // x,y = Ù…Ø®ØªØµØ§Øª Ø§ÙˆÙ„ÛŒÙ† Ù…Ø§Ø´ÛŒÙ†
    // cols = ØªØ¹Ø¯Ø§Ø¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
    // gapX = ÙØ§ØµÙ„Ù‡ Ø§ÙÙ‚ÛŒ Ø¨ÛŒÙ† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
    // gapY = ÙØ§ØµÙ„Ù‡ Ø¹Ù…ÙˆØ¯ÛŒ Ø¨ÛŒÙ† Ù…Ø§Ø´ÛŒÙ†â€ŒÙ‡Ø§
    // maxPerCol = Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ù‡Ø± Ø³ØªÙˆÙ†
    const ZONE_CONFIG = {
        blowroom: { x: 125, y: 55,  w: 48, h: 32, cols: 2, gapX: 55, gapY: 42, maxPerCol: 6 },
        carding:  { x: 263, y: 55,  w: 42, h: 28, cols: 4, gapX: 52, gapY: 36, maxPerCol: 7 },
        passage:  { x: 503, y: 55,  w: 42, h: 28, cols: 2, gapX: 52, gapY: 36, maxPerCol: 7 },
        finisher: { x: 633, y: 55,  w: 42, h: 28, cols: 2, gapX: 52, gapY: 36, maxPerCol: 7 },
        ring:     { x: 763, y: 55,  w: 52, h: 24, cols: 5, gapX: 94, gapY: 32, maxPerCol: 8 },
        // Ø®Ø· ØªÚ©Ù…ÛŒÙ„
        winding:  { x: 763, y: 393, w: 52, h: 32, cols: 2, gapX: 60, gapY: 42, maxPerCol: 3 },
        tfo:      { x: 928, y: 393, w: 52, h: 32, cols: 2, gapX: 60, gapY: 42, maxPerCol: 3 },
        heatset:  { x: 1093,y: 393, w: 52, h: 32, cols: 2, gapX: 60, gapY: 42, maxPerCol: 3 },
        // Ø±Ù†Ú¯Ø±Ø²ÛŒ
        dyeing:   { x: 23,  y: 393, w: 52, h: 32, cols: 4, gapX: 60, gapY: 42, maxPerCol: 3 },
    };

    const TYPE_LABELS = {
        blowroom: 'Ø­Ù„Ø§Ø¬ÛŒ', carding: 'Ú©Ø§Ø±Ø¯ÛŒÙ†Ú¯', passage: 'Ù¾Ø§Ø³Ø§Ú˜',
        finisher: 'ÙÛŒÙ†ÛŒØ´Ø±', ring: 'Ø±ÛŒÙ†Ú¯', winding: 'Ø¨ÙˆØ¨ÛŒÙ†â€ŒÙ¾ÛŒÚ†ÛŒ',
        tfo: 'Ø¯ÙˆÙ„Ø§ØªØ§Ø¨ÛŒ', heatset: 'Ù‡ÛŒØªâ€ŒØ³Øª', dyeing: 'Ø±Ù†Ú¯Ø±Ø²ÛŒ',
    };

    // â•â•â• Init â•â•â•
    fetchData();
    setInterval(tick, 1000);

    function fetchData() {
        fetch(API_URL, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
        .then(r => r.json())
        .then(data => {
            updateKPIs(data.summary);
            updateMeta(data);
            renderMachines(data.machines);
            countdown = REFRESH;
        })
        .catch(err => console.error('Floor map API error:', err));
    }

    function tick() {
        countdown--;
        const el = document.getElementById('meta-timer');
        if (el) el.textContent = countdown <= 0 ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...' : `Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§ ${countdown} Ø«Ø§Ù†ÛŒÙ‡`;
        if (countdown <= 0) fetchData();
    }

    function updateKPIs(s) {
        ['good','warning','critical','maintenance','idle'].forEach(k => {
            const el = document.getElementById('kpi-' + k);
            if (el) el.textContent = s[k] || 0;
        });
    }

    function updateMeta(data) {
        const d = document.getElementById('meta-date');
        const sh = document.getElementById('meta-shift');
        if (d) d.textContent = data.jalali_date;
        if (sh) sh.textContent = data.shift;
    }

    // â•â•â• Render Machines â•â•â•
    function renderMachines(machines) {
        const groups = {};
        machines.forEach(m => {
            if (!groups[m.type]) groups[m.type] = [];
            groups[m.type].push(m);
            machineDataMap[m.code] = m;
        });

        Object.keys(ZONE_CONFIG).forEach(type => {
            const zone = document.getElementById('zone-' + type);
            if (!zone) return;
            zone.innerHTML = '';
            const cfg = ZONE_CONFIG[type];
            const list = groups[type] || [];

            list.forEach((m, i) => {
                const col = Math.floor(i / cfg.maxPerCol);
                const row = i % cfg.maxPerCol;
                const x = cfg.x + col * cfg.gapX;
                const y = cfg.y + row * cfg.gapY;

                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('data-code', m.code);
                g.setAttribute('class', 'machine-group');

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x); rect.setAttribute('y', y);
                rect.setAttribute('width', cfg.w); rect.setAttribute('height', cfg.h);
                rect.setAttribute('class', `machine-rect heat-${m.heat_level}`);
                rect.setAttribute('rx', '4');

                const code = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                code.setAttribute('x', x + cfg.w / 2);
                code.setAttribute('y', y + cfg.h / 2 + (cfg.h > 28 ? 2 : 3));
                code.setAttribute('class', 'machine-code');
                code.textContent = m.code;

                // Ø±Ø§Ù†Ø¯Ù…Ø§Ù† Ø²ÛŒØ± Ú©Ø¯ (Ø§Ú¯Ø± ÙØ¶Ø§ Ø¨Ø§Ø´Ø¯)
                if (cfg.h >= 30) {
                    const eff = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    eff.setAttribute('x', x + cfg.w / 2);
                    eff.setAttribute('y', y + cfg.h / 2 + 12);
                    eff.setAttribute('class', 'machine-name');
                    eff.textContent = m.efficiency > 0 ? m.efficiency + '%' : '-';
                    g.appendChild(eff);
                }

                g.appendChild(rect);
                g.appendChild(code);

                g.addEventListener('mouseenter', e => showTooltip(e, m));
                g.addEventListener('mousemove', moveTooltip);
                g.addEventListener('mouseleave', hideTooltip);

                zone.appendChild(g);
            });
        });
    }

    // â•â•â• Tooltip â•â•â•
    const tooltip = document.getElementById('machine-tooltip');

    function showTooltip(e, m) {
        const f = machineDataMap[m.code] || m;
        document.getElementById('tt-name').textContent = f.name;
        document.getElementById('tt-code').textContent = f.code;
        document.getElementById('tt-type').textContent = TYPE_LABELS[f.type] || f.type;
        document.getElementById('tt-line').textContent = f.line_code;
        document.getElementById('tt-shift').textContent = f.shift;
        document.getElementById('tt-eff').textContent = f.efficiency > 0 ? f.efficiency + '%' : '-';
        document.getElementById('tt-output').textContent = f.output_kg > 0
            ? parseFloat(f.output_kg).toLocaleString('fa-IR', {maximumFractionDigits:1}) + ' kg' : '-';
        document.getElementById('tt-batch').textContent = f.last_batch || '-';

        const s = document.getElementById('tt-status');
        s.className = 'tt-status tt-status-' + f.heat_level;
        s.textContent = {good:'ÙØ¹Ø§Ù„',warning:'Ù‡Ø´Ø¯Ø§Ø±',critical:'Ø¨Ø­Ø±Ø§Ù†ÛŒ',maintenance:'ØªØ¹Ù…ÛŒØ±Ø§Øª',idle:'Ø®Ø§Ù…ÙˆØ´'}[f.heat_level] || '-';

        tooltip.classList.add('visible');
        moveTooltip(e);
    }

    function moveTooltip(e) {
        let x = e.clientX + 18, y = e.clientY + 18;
        if (x + 280 > window.innerWidth)  x = e.clientX - 290;
        if (y + 220 > window.innerHeight) y = e.clientY - 220;
        tooltip.style.left = x + 'px';
        tooltip.style.top  = y + 'px';
    }

    function hideTooltip() { tooltip.classList.remove('visible'); }

})();
</script>
{% endblock %}
