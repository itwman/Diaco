{% extends "reports/report_base.html" %}
{% block report_content %}

<!-- عنوان زنجیره -->
<div class="alert alert-primary d-flex align-items-center gap-3 mb-4" style="border-radius:10px;">
    <i class="ti ti-arrow-right-circle f-s-24"></i>
    <div>
        <strong>زنجیره تولید کامل:</strong>
        <span class="ms-2">رینگ (SP) ← بوبین‌پیچی (WD) ← دولاتابی (TFO) ← هیت‌ست (HS)</span>
    </div>
</div>

<!-- KPI هر مرحله -->
<div class="row g-3 mb-4">

    <!-- رینگ -->
    <div class="col-xl-3 col-md-6">
        <div class="card h-100 text-center" style="border-top:4px solid #4361ee;">
            <div class="card-body py-3">
                <div class="h-40 w-40 d-flex-center b-r-10 bg-light-primary mx-auto mb-2">
                    <i class="ti ti-rotate-clockwise f-s-20 text-primary"></i>
                </div>
                <p class="text-muted f-s-12 mb-1">رینگ (SP)</p>
                <h4 class="f-w-700 mb-0 text-primary">{{ sp_agg.total_kg|floatformat:1|default:"0" }} kg</h4>
                <div class="mt-1">
                    <span class="badge bg-light-primary f-s-11">{{ sp_agg.total }} بچ</span>
                    <span class="badge bg-light-success f-s-11 ms-1">{{ sp_agg.avg_eff|floatformat:1|default:"—" }}% راندمان</span>
                </div>
            </div>
        </div>
    </div>

    <!-- بوبین‌پیچی -->
    <div class="col-xl-3 col-md-6">
        <div class="card h-100 text-center" style="border-top:4px solid #0891b2;">
            <div class="card-body py-3">
                <div class="h-40 w-40 d-flex-center b-r-10 mx-auto mb-2" style="background:#cffafe;">
                    <i class="ti ti-rotate-2 f-s-20" style="color:#0891b2;"></i>
                </div>
                <p class="text-muted f-s-12 mb-1">بوبین‌پیچی (WD)</p>
                <h4 class="f-w-700 mb-0" style="color:#0891b2;">{{ wd_agg.total_kg|floatformat:1|default:"0" }} kg</h4>
                <div class="mt-1">
                    <span class="badge f-s-11" style="background:#cffafe;color:#0891b2;">{{ wd_agg.total }} بچ</span>
                    <span class="badge bg-light-warning f-s-11 ms-1">{{ wd_agg.avg_cuts|floatformat:0|default:"—" }} برش</span>
                </div>
            </div>
        </div>
    </div>

    <!-- دولاتابی -->
    <div class="col-xl-3 col-md-6">
        <div class="card h-100 text-center" style="border-top:4px solid #7c3aed;">
            <div class="card-body py-3">
                <div class="h-40 w-40 d-flex-center b-r-10 mx-auto mb-2" style="background:#ede9fe;">
                    <i class="ti ti-infinity f-s-20" style="color:#7c3aed;"></i>
                </div>
                <p class="text-muted f-s-12 mb-1">دولاتابی (TFO)</p>
                <h4 class="f-w-700 mb-0" style="color:#7c3aed;">{{ tfo_agg.total_kg|floatformat:1|default:"0" }} kg</h4>
                <div class="mt-1">
                    <span class="badge f-s-11" style="background:#ede9fe;color:#7c3aed;">{{ tfo_agg.total }} بچ</span>
                    <span class="badge bg-light-danger f-s-11 ms-1">{{ tfo_agg.total_breakage|default:0 }} پارگی</span>
                </div>
            </div>
        </div>
    </div>

    <!-- هیت‌ست -->
    <div class="col-xl-3 col-md-6">
        <div class="card h-100 text-center" style="border-top:4px solid #dc2626;">
            <div class="card-body py-3">
                <div class="h-40 w-40 d-flex-center b-r-10 mx-auto mb-2" style="background:#fee2e2;">
                    <i class="ti ti-flame f-s-20" style="color:#dc2626;"></i>
                </div>
                <p class="text-muted f-s-12 mb-1">هیت‌ست (HS)</p>
                <h4 class="f-w-700 mb-0" style="color:#dc2626;">{{ hs_agg.total_kg|floatformat:1|default:"0" }} kg</h4>
                <div class="mt-1">
                    <span class="badge f-s-11" style="background:#fee2e2;color:#dc2626;">{{ hs_agg.total }} بچ</span>
                    <span class="badge bg-light-success f-s-11 ms-1">{{ hs_agg.pass_rate }}% قبول</span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- نمودار ستونی خروجی هر مرحله -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><h6 class="mb-0"><i class="ti ti-chart-bar me-1"></i> مقایسه خروجی مراحل (kg)</h6></div>
            <div class="card-body"><div id="chart-chain-stages" style="height:280px;"></div></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><h6 class="mb-0"><i class="ti ti-chart-line me-1"></i> روند روزانه همه مراحل</h6></div>
            <div class="card-body"><div id="chart-chain-trend" style="height:280px;"></div></div>
        </div>
    </div>
</div>

<!-- جدول ضایعات زنجیره -->
<div class="card mb-4">
    <div class="card-header"><h6 class="mb-0"><i class="ti ti-trash me-1"></i> تحلیل ضایعات زنجیره</h6></div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr><th>مرحله</th><th>ورودی (kg)</th><th>خروجی (kg)</th><th>ضایعات (kg)</th><th>درصد ضایعات</th><th>وضعیت</th></tr>
                </thead>
                <tbody>
                    {% for cl in chain_losses %}
                    <tr>
                        <td><strong>{{ cl.stage }}</strong></td>
                        <td>{{ cl.input_kg }}</td>
                        <td>{{ cl.output_kg }}</td>
                        <td>{{ cl.loss_kg }}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="height:6px;">
                                    <div class="progress-bar {% if cl.loss_pct > 8 %}bg-danger{% elif cl.loss_pct > 4 %}bg-warning{% else %}bg-success{% endif %}"
                                         style="width:{{ cl.loss_pct|floatformat:0 }}%; min-width:2px;"></div>
                                </div>
                                <span class="f-s-12 f-w-600 {% if cl.loss_pct > 8 %}text-danger{% elif cl.loss_pct > 4 %}text-warning{% else %}text-success{% endif %}">
                                    {{ cl.loss_pct }}%
                                </span>
                            </div>
                        </td>
                        <td>
                            {% if cl.loss_pct > 8 %}<span class="badge bg-danger">بحرانی</span>
                            {% elif cl.loss_pct > 4 %}<span class="badge bg-warning">هشدار</span>
                            {% elif cl.input_kg > 0 %}<span class="badge bg-success">نرمال</span>
                            {% else %}<span class="badge bg-secondary">بدون داده</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- پیوند به گزارش‌های تخصصی -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><h6 class="mb-0"><i class="ti ti-external-link me-1"></i> گزارش‌های تخصصی</h6></div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-3">
                    <a href="{% url 'reports:winding_report' %}?from={{ date_from }}&to={{ date_to }}" class="btn" style="background:#cffafe;color:#0891b2;">
                        <i class="ti ti-rotate-2 me-1"></i> گزارش بوبین‌پیچی
                    </a>
                    <a href="{% url 'reports:tfo_report' %}?from={{ date_from }}&to={{ date_to }}" class="btn" style="background:#ede9fe;color:#7c3aed;">
                        <i class="ti ti-infinity me-1"></i> گزارش دولاتابی
                    </a>
                    <a href="{% url 'reports:heatset_report' %}?from={{ date_from }}&to={{ date_to }}" class="btn" style="background:#fee2e2;color:#dc2626;">
                        <i class="ti ti-flame me-1"></i> گزارش هیت‌ست
                    </a>
                    <a href="{% url 'reports:waste_report' %}?from={{ date_from }}&to={{ date_to }}" class="btn btn-outline-secondary">
                        <i class="ti ti-trash me-1"></i> گزارش ضایعات کل
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block report_js %}
<script>
var stageData = {{ stage_chart|safe }};
var trendData = {{ trend_data|safe }};

new ApexCharts(document.querySelector("#chart-chain-stages"), {
    chart: {type:'bar', height:280, fontFamily:'Vazirmatn FD', toolbar:{show:false}},
    series: [{name:'خروجی (kg)', data: stageData.map(d=>d.value)}],
    xaxis: {categories: stageData.map(d=>d.label)},
    colors: ['#4361ee','#0891b2','#7c3aed','#dc2626'],
    plotOptions: {bar:{borderRadius:6, columnWidth:'55%', distributed:true}},
    legend: {show:false},
    dataLabels: {enabled:true, formatter: val => val + ' kg'},
}).render();

new ApexCharts(document.querySelector("#chart-chain-trend"), {
    chart: {type:'line', height:280, fontFamily:'Vazirmatn FD', toolbar:{show:false}},
    series: [
        {name:'رینگ (kg)', data: trendData.map(d=>d.sp)},
        {name:'WD (kg)',   data: trendData.map(d=>d.wd)},
        {name:'TFO (kg)',  data: trendData.map(d=>d.tfo)},
        {name:'HS (kg)',   data: trendData.map(d=>d.hs)},
    ],
    xaxis: {categories: trendData.map(d=>d.date), labels:{rotate:-45, style:{fontSize:'10px'}}},
    colors: ['#4361ee','#0891b2','#7c3aed','#dc2626'],
    stroke: {curve:'smooth', width:[2,2,2,2], dashArray:[0,0,0,0]},
    legend: {position:'top'},
    tooltip: {shared:true},
}).render();
</script>
{% endblock %}
